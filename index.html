<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>OS_Office_ANN</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.7, maximum-scale=1.0, user-scalable=no" />
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/7obx0vd.jpg">
  <link rel="apple-touch-icon" href="https://i.imgur.com/7obx0vd.jpg">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap">
  <style>
    input::-ms-reveal,
    input::-ms-clear { display: none !important; }
    input[type=password]::-webkit-textfield-decoration-container {
      visibility: hidden !important;
      pointer-events: none !important;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    body {
      background: linear-gradient(145deg, #0a0a0a, #1a1a1a);
      font-family: 'Roboto Mono', monospace;
      color: #e0e0e0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      font-weight: 700;
      text-shadow: 1px 1px 2px #000;
    }
    .container {
      background: rgba(20, 20, 20, 0.95);
      border: 2px solid #333;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8), inset 0 2px 4px rgba(255,255,255,0.05);
      padding: 40px;
      max-width: 700px;
      width: 100%;
      text-align: center;
    }
    .logo {
      width: 120px;
      margin: 0 auto 20px;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.6));
    }
    h1 {
      font-size: 36px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #fff;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 20px;
      color: #bbb;
      margin-bottom: 30px;
    }
    form {
      background: rgba(40,40,40,0.8);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.7);
    }
    label {
      display: block;
      font-size: 18px;
      margin-bottom: 10px;
      color: #ccc;
    }
    .input-group {
      position: relative;
      margin-bottom: 8px;
    }
    input[type="password"],
    input[type="text"],
    input[type="tel"] {
      width: 100%;
      font-size: 20px;
      padding: 14px 50px 14px 16px;
      border: none;
      border-radius: 6px;
      background-color: #222;
      color: #fff;
      text-align: center;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
      transition: background 0.3s, box-shadow 0.3s;
    }
    input:focus {
      background-color: #333;
      box-shadow: 0 0 8px rgba(0,176,255,0.6), inset 0 2px 6px rgba(0,0,0,0.5);
    }
    .toggle-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #aaa;
      font-size: 22px;
      cursor: pointer;
      transition: color 0.3s;
    }
    .toggle-btn:hover { color: #fff; }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .btn {
      flex: 1 1 120px;
      padding: 12px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.6), inset 0 -2px 0 rgba(0,0,0,0.2);
      color: #fff;
      background-size: 100% 100%;
      transition: none;
    }
    .btn:hover { transform: translateY(-3px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(to right, #666, #555);
    }
    .btn-on { background: linear-gradient(to right, #28a745 0%, #1e7e34 100%); }
    .btn-off { background: linear-gradient(to right, #e74c3c 0%, #c0392b 100%); }
    .btn-query { background: linear-gradient(to right, #3498db 0%, #2980b9 100%); }
    .btn-test { background: linear-gradient(to right, #f39c12 0%, #e67e22 100%); }
    /* 表單申請按鈕樣式 */
    .btn-form { background: linear-gradient(to right, #9c27b0 0%, #673ab7 100%); }
    
    #response {
      margin-top: 10px;
      font-size: 16px;
      background: rgba(0,0,0,0.4);
      border-radius: 6px;
      padding: 10px;
      min-height: 40px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.7);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      color: #76ff03;
      overflow-x: auto;
    }
    #response.show {
      opacity: 1;
      transform: translateY(0);
    }
    #response table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
      text-align: center;
      border: 1px solid #555;
      font-size: 14px;
    }
    #response th, #response td {
      padding: 4px;
      border: 1px solid #666;
      white-space: nowrap;
    }
    .loading {
      font-size: 16px;
      color: #ff4444;
      animation: blink 1s infinite;
    }
    .loading::before {
      content: "";
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #ccc;
      border-radius: 50%;
      border-top-color: #09f;
      animation: spin 0.8s infinite linear;
      vertical-align: middle;
      margin-right: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .overlay.show { display: flex; }
    .modal {
      background: #222;
      padding: 24px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
      color: #fff;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
    }
    .modal h3 {
      font-size: 24px;
      margin-bottom: 12px;
      letter-spacing: 1px;
    }
    .modal p {
      font-size: 18px;
      margin-bottom: 20px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: space-evenly;
    }
    .modal .btn {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      font-size: 20px;
      font-family: 'Roboto Mono', monospace;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: none;
      border: none;
    }
    .btn-confirm { background: #28a745; color: #fff; }
    .btn-cancel { background: #e74c3c; color: #fff; }
    .btn-confirm:hover { background: #1e7e34; }
    .btn-cancel:hover { background: #c0392b; }
    #incognitoPrompt {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #incognitoPrompt .prompt-content {
      background: #222;
      border: 2px solid #444;
      border-radius: 10px;
      padding: 20px 30px;
      text-align: center;
      max-width: 450px;
      width: 90%;
    }
    #incognitoPrompt h2 {
      margin-bottom: 20px;
      color: #fff;
      font-size: 24px;
    }
    #incognitoPrompt p {
      margin-bottom: 20px;
      font-size: 18px;
      color: #ddd;
    }
    #incognitoPrompt .button-group {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    #incognitoPrompt .button-group button {
      font-family: 'Roboto Mono', monospace;
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #confirmIncognito { background-color: #28a745; color: #fff; }
    #confirmIncognito:hover { background-color: #1e7e34; }
    #cancelIncognito { background-color: #e74c3c; color: #fff; }
    #cancelIncognito:hover { background-color: #c0392b; }
    #videoTutorialModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 11000;
      padding: 20px;
    }
    #videoTutorialModal .video-content {
      background: #222;
      border: 2px solid #444;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      max-width: 600px;
      width: 100%;
      position: relative;
    }
    #videoTutorialModal video {
      width: 100%;
      height: auto;
      border-radius: 6px;
    }
    #videoTutorialModal .fallback-link {
      display: none;
      margin-top: 10px;
      color: #76ff03;
      font-size: 18px;
    }
    #videoTutorialModal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .network-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 999;
      transition: all 0.3s ease;
    }
    .network-online { background-color: rgba(40, 167, 69, 0.8); color: #fff; }
    .network-offline { background-color: rgba(220, 53, 69, 0.8); color: #fff; }
    .error-message {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      color: red;
      font-size: 14px;
      display: none;
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .error-message.show { display: block; opacity: 1; }
    .browser-notice {
      padding: 8px 12px;
      background-color: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      margin-bottom: 16px;
      text-align: center;
      display: none;
    }
    .browser-notice.show { display: block; }
    
    /* 表單模態框樣式 */
    .form-modal {
      background: rgba(28, 28, 30, 0.95);
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      color: #fff;
      text-align: left;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
      animation: modalFadeIn 0.3s ease;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .form-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-modal-header h3 {
      font-size: 20px;
      margin: 0;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .close-form-btn {
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .close-form-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .form-modal-content {
      padding: 8px 0;
    }
    
    .form-item-container {
      display: flex;
      flex-direction: column;
    }
    
    .form-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }
    
    .form-item:after {
      content: '';
      position: absolute;
      left: 20px;
      right: 20px;
      bottom: 0;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .form-item:last-child:after {
      display: none;
    }
    
    .form-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .form-item:active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .form-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    
    .form-icon .material-icons {
      font-size: 24px;
    }
    
    #overtimeForm .form-icon {
      color: #ff9800;
    }
    
    #cardCorrectionForm .form-icon {
      color: #03a9f4;
    }
    
    #leaveRequestForm .form-icon {
      color: #4caf50;
    }
    
    .form-info {
      flex: 1;
    }
    
    .form-info h4 {
      font-size: 17px;
      margin: 0 0 4px 0;
      font-weight: 600;
    }
    
    .form-info p {
      font-size: 14px;
      margin: 0;
      color: #999;
    }
    
    .form-arrow {
      color: #777;
    }
    
    /* 對話框背景模糊效果 */
    .overlay.show.form-overlay {
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
  </style>
</head>
<body>
  <div id="networkStatus" class="network-status network-online">已連線</div>
  <div class="container">
    <img class="logo" src="https://i.imgur.com/segag5B.jpg" alt="Logo" crossorigin="anonymous">
    <h1>OS_Office_ANN</h1>
    <h2>請輸入身分證後四碼執行打卡</h2>
    <div id="safariNotice" class="browser-notice">
      <p>若遇到打卡問題｜請截圖回報營運組</p>
    </div>
    <form id="idForm">
      <label for="idCode">請點擊下方框內輸入後四碼</label>
      <div class="input-group">
        <input 
          type="password" 
          id="idCode" 
          name="idCode" 
          required 
          pattern="\d{4}" 
          maxlength="4" 
          inputmode="numeric"
          autocomplete="off" 
          autocorrect="off" 
          autocapitalize="off" 
          spellcheck="false"
        />
        <button type="button" class="toggle-btn" id="toggleBtn">
          <span class="material-icons" id="eyeIcon">visibility</span>
        </button>
        <span class="error-message"></span>
      </div>
    </form>
    <div class="btn-group">
      <button type="button" class="btn btn-on" id="btnOn" data-original-text="上班" disabled>上班</button>
      <button type="button" class="btn btn-off" id="btnOff" data-original-text="下班" disabled>下班</button>
      <button type="button" class="btn btn-query" id="btnQuery" data-original-text="查詢記錄" disabled>查詢記錄</button>
      <button type="button" class="btn btn-test" id="btnTest" data-original-text="測試定位" disabled>測試定位</button>
      <button type="button" class="btn btn-form" id="btnForm" data-original-text="各項表單申請" disabled>各項表單申請</button>
    </div>
    <div id="response" role="status" aria-live="polite"></div>
  </div>
  <div id="overlay" class="overlay">
    <div class="modal">
      <h3 id="modal-title">提示</h3>
      <p id="modal-message">提示訊息</p>
      <div class="modal-buttons">
        <button id="modal-confirm" class="btn btn-confirm">確定</button>
        <button id="modal-cancel" class="btn btn-cancel">取消</button>
      </div>
    </div>
  </div>
  <div id="incognitoPrompt">
    <div class="prompt-content">
      <h2>系統提示</h2>
      <p>請確保關閉無痕瀏覽器模式後再執行</p>
      <div class="button-group">
        <button id="confirmIncognito">我已確認關閉</button>
        <button id="cancelIncognito">取消</button>
      </div>
    </div>
  </div>
  <div id="videoTutorialModal">
    <div class="video-content">
      <button class="close-btn" id="closeVideoModal">×</button>
      <video id="tutorialVideo" controls>
        <source src="https://i.imgur.com/Wnemzxu.mp4" type="video/mp4">
        您的瀏覽器不支援影片播放，請點此觀看：
        <a href="https://i.imgur.com/Wnemzxu.mp4" target="_blank">https://i.imgur.com/Wnemzxu.mp4</a>
      </video>
      <div class="fallback-link" id="videoFallback">
        <a href="https://i.imgur.com/Wnemzxu.mp4" target="_blank">無法播放影片？請點此觀看</a>
      </div>
    </div>
  </div>
  
  <!-- 表單申請模態框 -->
  <div id="formApplicationModal" class="overlay">
    <div class="form-modal">
      <div class="form-modal-header">
        <h3>各項表單申請</h3>
        <button id="closeFormModal" class="close-form-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="form-modal-content">
        <div class="form-item-container">
          <div class="form-item" id="overtimeForm">
            <div class="form-icon">
              <span class="material-icons">schedule</span>
            </div>
            <div class="form-info">
              <h4>加班申請</h4>
              <p>提交加班時數及原因</p>
            </div>
            <div class="form-arrow">
              <span class="material-icons">chevron_right</span>
            </div>
          </div>
          
          <div class="form-item" id="cardCorrectionForm">
            <div class="form-icon">
              <span class="material-icons">credit_card</span>
            </div>
            <div class="form-info">
              <h4>補卡申請</h4>
              <p>忘記打卡或打卡錯誤</p>
            </div>
            <div class="form-arrow">
              <span class="material-icons">chevron_right</span>
            </div>
          </div>
          
          <div class="form-item" id="leaveRequestForm">
            <div class="form-icon">
              <span class="material-icons">event_busy</span>
            </div>
            <div class="form-info">
              <h4>請假申請</h4>
              <p>請假日期及假別選擇</p>
            </div>
            <div class="form-arrow">
              <span class="material-icons">chevron_right</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // 確保 JavaScript 啟用提示
    if (typeof window === 'undefined' || !window.document) {
      document.body.innerHTML = '<p style="color: red; text-align: center;">請啟用 JavaScript 以使用此應用程式。</p>';
    }
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz76tporyDWPW1TvwhCk2rVtnph1wRsNoC7k8Q402VYoZhV6ysp_DgIcVKP6pJLQauYVQ/exec";
    const COOLDOWN_MS = 5000;
    const CONSISTENCY_CHECK_INTERVAL = 30000;
    const elements = {
      toggleBtn: document.getElementById("toggleBtn"),
      idInput: document.getElementById("idCode"),
      eyeIcon: document.getElementById("eyeIcon"),
      responseDiv: document.getElementById("response"),
      overlay: document.getElementById("overlay"),
      modalTitle: document.getElementById("modal-title"),
      modalMessage: document.getElementById("modal-message"),
      confirmBtn: document.getElementById("modal-confirm"),
      cancelBtn: document.getElementById("modal-cancel"),
      incognitoPrompt: document.getElementById("incognitoPrompt"),
      confirmIncognito: document.getElementById("confirmIncognito"),
      cancelIncognito: document.getElementById("cancelIncognito"),
      videoTutorialModal: document.getElementById("videoTutorialModal"),
      closeVideoModal: document.getElementById("closeVideoModal"),
      tutorialVideo: document.getElementById("tutorialVideo"),
      videoFallback: document.getElementById("videoFallback"),
      networkStatus: document.getElementById("networkStatus"),
      errorSpan: document.querySelector(".error-message"),
      safariNotice: document.getElementById("safariNotice"),
      allButtons: {
        btnOn: document.getElementById("btnOn"),
        btnOff: document.getElementById("btnOff"),
        btnQuery: document.getElementById("btnQuery"),
        btnTest: document.getElementById("btnTest")
      }
    };
    const originalButtonStyles = {
      btnOn: 'linear-gradient(to right, #28a745 0%, #1e7e34 100%)',
      btnOff: 'linear-gradient(to right, #e74c3c 0%, #c0392b 100%)',
      btnQuery: 'linear-gradient(to right, #3498db 0%, #2980b9 100%)',
      btnTest: 'linear-gradient(to right, #f39c12 0%, #e67e22 100%)'
    };
    const DEVICE_ID_KEY = 'OS_DEVICE_ID';
    const APP_VERSION = '1.0.1';
    // 檢查是否為 Safari 瀏覽器
    function isSafari() {
      const ua = navigator.userAgent.toLowerCase();
      return /safari/.test(ua) && !/chrome/.test(ua);
    }
    // 顯示 Safari 瀏覽器提示
    function showSafariNotice() {
      if (isSafari()) {
        elements.safariNotice.classList.add('show');
      }
    }
    // 取得或設置 Cookie
    function getCookie(name) {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
      }
      return null;
    }
    function setCookie(name, value, days) {
      try {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/;SameSite=Strict";
        return true;
      } catch (e) {
        console.error("設置 Cookie 失敗:", e);
        return false;
      }
    }
    // 生成備用識別碼
    function generateFallbackID() {
      if (crypto && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
      return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    // 多重儲存設備識別碼
    function saveDeviceID(deviceID) {
      if (!deviceID) {
        console.error("嘗試儲存空的設備識別碼");
        return false;
      }
      let successCount = 0;
      try {
        localStorage.setItem(DEVICE_ID_KEY, deviceID);
        localStorage.setItem(DEVICE_ID_KEY + '_timestamp', Date.now().toString());
        localStorage.setItem(DEVICE_ID_KEY + '_version', APP_VERSION);
        successCount++;
      } catch (e) {
        console.warn("無法儲存到 localStorage:", e);
      }
      try {
        sessionStorage.setItem(DEVICE_ID_KEY, deviceID);
        sessionStorage.setItem(DEVICE_ID_KEY + '_timestamp', Date.now().toString());
        successCount++;
      } catch (e) {
        console.warn("無法儲存到 sessionStorage:", e);
      }
      if (setCookie(DEVICE_ID_KEY, deviceID, 365)) successCount++;
      return successCount > 0;
    }
    // 驗證並糾正已儲存的識別碼
    function validateStoredIDs() {
      const localID = localStorage.getItem(DEVICE_ID_KEY);
      const sessionID = sessionStorage.getItem(DEVICE_ID_KEY);
      const cookieID = getCookie(DEVICE_ID_KEY);
      let primaryID = null;
      let needsRepair = false;
      if (localID) {
        primaryID = localID;
        const storedVersion = localStorage.getItem(DEVICE_ID_KEY + '_version');
        if (storedVersion !== APP_VERSION) {
          localStorage.setItem(DEVICE_ID_KEY + '_version', APP_VERSION);
        }
      } else if (cookieID) {
        primaryID = cookieID;
        needsRepair = true;
      } else if (sessionID) {
        primaryID = sessionID;
        needsRepair = true;
      }
      if (primaryID && (primaryID !== localID || primaryID !== sessionID || primaryID !== cookieID)) needsRepair = true;
      if (primaryID && needsRepair) {
        console.log("檢測到識別碼不一致，正在修復...");
        saveDeviceID(primaryID);
        return true;
      }
      return false;
    }
    // 取得裝置識別碼
    async function getDeviceUUID() {
      const storedID = localStorage.getItem(DEVICE_ID_KEY) || sessionStorage.getItem(DEVICE_ID_KEY) || getCookie(DEVICE_ID_KEY);
      if (storedID) {
        validateStoredIDs();
        return storedID;
      }
      try {
        const stableFeatures = [
          navigator.platform || '',
          screen.width + 'x' + screen.height,
          navigator.language || '',
          screen.colorDepth || 0,
          navigator.userAgent.substring(0, 100)
        ];
        if (!isSafari()) {
          stableFeatures.push(navigator.hardwareConcurrency || 0);
          stableFeatures.push(window.devicePixelRatio || 0);
          stableFeatures.push(getWebGLFingerprint());
        }
        const ip = await getIPAddress().catch(() => 'unknown');
        stableFeatures.push(ip);
        const deviceFingerprint = stableFeatures.join('|');
        const newID = await hashString(deviceFingerprint).catch(() => generateFallbackID());
        saveDeviceID(newID);
        return newID;
      } catch (err) {
        console.error("生成設備識別碼失敗:", err);
        const fallbackID = generateFallbackID();
        saveDeviceID(fallbackID);
        return fallbackID;
      }
    }
    // 網路狀態監控
    function updateNetworkStatus() {
      if (navigator.onLine) {
        elements.networkStatus.textContent = "已連線";
        elements.networkStatus.className = "network-status network-online";
      } else {
        elements.networkStatus.textContent = "離線";
        elements.networkStatus.className = "network-status network-offline";
        displayError("網路連線已中斷");
      }
    }
    window.addEventListener('online', updateNetworkStatus);
    window.addEventListener('offline', updateNetworkStatus);
    // 防抖動函數
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }
    // 按鈕控制
    function disableAllButtons() {
      Object.values(elements.allButtons).forEach(button => {
        button.disabled = true;
        button.style.background = 'linear-gradient(to right, #666, #555)';
      });
    }
    function enableAllButtons() {
      Object.values(elements.allButtons).forEach(button => {
        button.disabled = false;
        button.style.background = originalButtonStyles[button.id];
      });
    }
    function enableAllButtonsExcept(buttonToExclude) {
      Object.values(elements.allButtons).forEach(button => {
        if (button.id !== buttonToExclude.id) {
          button.disabled = false;
          button.style.background = originalButtonStyles[button.id];
        }
      });
    }
    function startIndividualCooldown(button, duration, originalText) {
      button.disabled = true;
      button.textContent = originalText;
      const originalColors = originalButtonStyles[button.id].match(/#\w+/g);
      const grayColor = '#666';
      let startTime = null;
      function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = (timestamp - startTime) / duration;
        const fillPercent = Math.min(progress * 100, 100);
        if (progress < 1) {
          button.style.background = `linear-gradient(to right, ${originalColors[0]} 0%, ${originalColors[1]} ${fillPercent}%, ${grayColor} ${fillPercent}%, ${grayColor} 100%)`;
          requestAnimationFrame(step);
        } else {
          button.style.background = originalButtonStyles[button.id];
          button.disabled = false;
        }
      }
      button.style.background = `linear-gradient(to right, ${grayColor}, ${grayColor})`;
      requestAnimationFrame(step);
    }
    // 雜湊函數
    async function hashString(str) {
      try {
        if (!str) throw new Error("無法雜湊空字串");
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, "0")).join("");
      } catch (err) {
        console.error("雜湊函數失敗:", err);
        return generateFallbackID();
      }
    }
    // 獲取 IP 地址
    async function getIPAddress() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        const response = await fetch('https://api.ipify.org?format=json', { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`網路錯誤: ${response.status}`);
        const data = await response.json();
        return data.ip;
      } catch (err) {
        console.error("無法獲取 IP:", err);
        return 'unknown';
      }
    }
    // 獲取 WebGL 指紋
    function getWebGLFingerprint() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl');
        if (!gl) return 'WebGL not supported';
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) || 'unknown_vendor';
          const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || 'unknown_renderer';
          return `${vendor}-${renderer}`;
        }
        return 'No debug info';
      } catch (err) {
        console.error("WebGL 指紋失敗:", err);
        return 'WebGL error';
      }
    }
    // 輸入驗證
    function validateIdCode(idCode) {
      return /^\d{4}$/.test(idCode);
    }
    // 顯示回應
    function displayError(msg) {
      elements.responseDiv.innerHTML = `<div style="color:red; text-align:center;">${msg}</div>`;
      elements.responseDiv.classList.add("show");
    }
    function displaySuccess(msg) {
      elements.responseDiv.innerHTML = `<div style="color:green; font-weight:bold; text-align:center;">${msg}</div>`;
      elements.responseDiv.classList.add("show");
    }
    function displayLoading(msg) {
      elements.responseDiv.innerHTML = `<span class="loading">${msg || "載入中｜請稍候..."}</span>`;
      elements.responseDiv.classList.add("show");
    }
    function clearResponse() {
      elements.responseDiv.innerHTML = "";
      elements.responseDiv.classList.remove("show");
    }
    // 瀏覽器檢測
    function parseBrowser(userAgent) {
      const ua = userAgent.toLowerCase();
      if (/edg\//.test(ua)) return "Edge";
      if (/chrome\//.test(ua)) return "Chrome";
      if (/safari\//.test(ua) && !/chrome\//.test(ua)) return "Safari";
      if (/firefox\//.test(ua)) return "Firefox";
      if (/opera\//.test(ua) || /opr\//.test(ua)) return "Opera";
      if (/trident\//.test(ua)) return "Internet Explorer";
      return "未知瀏覽器";
    }
    // 伺服器通訊
    async function callGAS(functionName, parametersArray) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);
        const formData = new URLSearchParams();
        formData.append("function", functionName);
        formData.append("parameters", JSON.stringify(parametersArray));
        const response = await fetch(WEB_APP_URL, {
          method: "POST",
          mode: "cors",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: formData,
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`網路錯誤: ${response.status}`);
        return await response.json();
      } catch (err) {
        if (err.name === 'AbortError') throw new Error('請求超時｜請稍後再試');
        throw new Error(`請求失敗: ${err.message}`);
      }
    }
    // 對話框顯示
    function showCustomConfirm(title, message, onConfirm, onCancel) {
      elements.modalTitle.textContent = title || "提示";
      elements.modalMessage.textContent = message;
      elements.overlay.classList.add("show");
      elements.confirmBtn.onclick = () => {
        elements.overlay.classList.remove("show");
        if (onConfirm) onConfirm();
      };
      elements.cancelBtn.onclick = () => {
        elements.overlay.classList.remove("show");
        if (onCancel) onCancel();
      };
    }
    // 打卡流程
    async function startClockAction(action, force, button) {
      disableAllButtons();
      const idCode = elements.idInput.value;
      if (!validateIdCode(idCode)) {
        displayError("請輸入完整的身分證後四碼");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
        return;
      }
      if (!navigator.onLine) {
        displayError("請確認網路連線");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
        return;
      }
      displayLoading("檢查中｜請稍候...");
      try {
        const result = await callGAS("checkDeviceBinding", [idCode]);
        if (result.status === "success") {
          startCountdown(action, force, false, button);
        } else if (result.status === "error") {
          if (result.error === "NOT_BOUND") {
            const browser = parseBrowser(navigator.userAgent);
            showCustomConfirm(
              "裝置綁定確認",
              `是否同意綁定 ${browser}`,
              () => startCountdown(action, force, true, button),
              () => {
                displayError("已取消打卡");
                startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
                enableAllButtonsExcept(button);
              }
            );
          } else {
            displayError(result.message);
            startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
            enableAllButtonsExcept(button);
          }
        }
      } catch (err) {
        displayError(`檢查失敗: ${err.message}`);
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
      }
    }
    // 倒數函數
    function startCountdown(action, force, bindDevice, button) {
      disableAllButtons();
      elements.overlay.classList.add("show");
      elements.modalTitle.textContent = "打卡確認";
      let countdown = 5;
      elements.modalMessage.textContent = `將於 ${countdown} 秒後建立 ${action} 打卡`;
      const timer = setInterval(() => {
        countdown--;
        elements.modalMessage.textContent = `將於 ${countdown} 秒後建立 ${action} 打卡`;
        if (countdown <= 0) {
          clearInterval(timer);
          elements.overlay.classList.remove("show");
          handleAction(action, force, bindDevice, button);
        }
      }, 1000);
      elements.confirmBtn.onclick = () => {
        clearInterval(timer);
        elements.overlay.classList.remove("show");
        handleAction(action, force, bindDevice, button);
      };
      elements.cancelBtn.onclick = () => {
        clearInterval(timer);
        elements.overlay.classList.remove("show");
        displayError("已取消打卡");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
      };
    }
    // 字體檢測
    function detectCommonFonts() {
      const fontList = ['Arial', 'Times New Roman', 'Courier New', 'Georgia', 'Verdana', 'Helvetica', 'Tahoma', 'Trebuchet MS'];
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      if (!context) return "canvas_unsupported";
      const testString = "abcdefghijklmnopqrstuvwxyz123456789";
      context.font = "72px monospace";
      const baselineSize = context.measureText(testString).width;
      const detectedFonts = fontList.filter(font => {
        context.font = `72px '${font}', monospace`;
        return context.measureText(testString).width !== baselineSize;
      });
      return detectedFonts.length > 0 ? detectedFonts.join('|').substring(0, 100) : "no_fonts_detected";
    }
    // 處理打卡動作
    async function handleAction(action, force, bindDevice, button) {
      disableAllButtons();
      const idCode = elements.idInput.value;
      displayLoading("審核中｜請稍候...");
      try {
        const coords = await new Promise((resolve, reject) => getLocation(resolve, reject));
        const coordsList = [{ lat: coords.lat, lng: coords.lng }];
        const deviceInfo = JSON.stringify({
          OS: navigator.platform || "未知",
          Browser: navigator.userAgent || "未知",
          ScreenResolution: `${window.screen.width}x${window.screen.height}`,
          TimeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || "未知",
          Language: navigator.language || "未知",
          HardwareConcurrency: navigator.hardwareConcurrency || 0,
          DeviceMemory: navigator.deviceMemory || 0,
          MaxTouchPoints: navigator.maxTouchPoints || 0,
          ColorDepth: window.screen.colorDepth || 24,
          PixelRatio: window.devicePixelRatio || 1,
          IsSafari: isSafari(),
          TouchSupport: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0),
          AvailScreen: `${window.screen.availWidth}x${window.screen.availHeight}`,
          Fonts: detectCommonFonts(),
          AppVersion: APP_VERSION
        });
        const currentDeviceInfo = JSON.stringify({
          Browser: navigator.userAgent || "未知",
          DeviceMemory: navigator.deviceMemory || 0,
          PixelRatio: window.devicePixelRatio || 1,
          ColorDepth: window.screen.colorDepth || 24,
          OS: navigator.platform || "未知",
          ScreenResolution: `${window.screen.width}x${window.screen.height}`,
          Language: navigator.language || "未知",
          IsSafari: isSafari(),
          TimeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || "未知",
          TouchSupport: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0),
          AvailScreen: `${window.screen.availWidth}x${window.screen.availHeight}`,
          Fonts: detectCommonFonts(),
          MaxTouchPoints: navigator.maxTouchPoints || 0,
          HardwareConcurrency: navigator.hardwareConcurrency || 0
        });
        const uuid = await getDeviceUUID();
        const ip = await getIPAddress();
        const result = await callGAS("gpsCheckin", [idCode, deviceInfo, action, coordsList, force, bindDevice, uuid, ip, currentDeviceInfo]);
        if (result.status === "success") {
          let finalMsg = result.message;
          if (result.detail?.time) finalMsg += `<br><span style="color:#fff;">${result.detail.time}</span>`;
          displaySuccess(finalMsg);
          startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
          enableAllButtonsExcept(button);
        } else {
          let finalMsg = result.message;
          if (result.error === "DEVICE_UUID_MISMATCH" || result.error === "DEVICE_MISMATCH") {
            finalMsg += "<br><span style='color:yellow;'>裝置異常請洽營運組</span>";
          }
          if (result.details) finalMsg += `<br><span style="font-size:14px;">詳細資訊: ${JSON.stringify(result.details)}</span>`;
          displayError(finalMsg);
          startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
          enableAllButtonsExcept(button);
        }
      } catch (err) {
        displayError(`連線失敗: ${err.message}`);
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
      }
    }
    // 定位相關
    function getLocation(successCallback, errorCallback) {
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          position => successCallback({ lat: position.coords.latitude, lng: position.coords.longitude }),
          error => {
            let errorMsg = "定位失敗";
            switch (error.code) {
              case error.PERMISSION_DENIED: errorMsg = "定位失敗｜請開啟定位權限"; break;
              case error.POSITION_UNAVAILABLE: errorMsg = "定位失敗｜無法取得位置"; break;
              case error.TIMEOUT: errorMsg = "定位失敗｜請求逾時"; break;
            }
            errorCallback(errorMsg);
          },
          { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
      } else {
        errorCallback("瀏覽器不支援定位");
      }
    }
    // 測試定位
    const testLocation = debounce(async (button) => {
      disableAllButtons();
      const idCode = elements.idInput.value;
      if (!validateIdCode(idCode)) {
        displayError("請輸入完整的身分證後四碼");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
        return;
      }
      if (!navigator.onLine) {
        displayError("離線無法測試定位");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
        return;
      }
      displayLoading("定位測試中｜請稍候...");
      try {
        const coords = await new Promise((resolve, reject) => getLocation(resolve, reject));
        const coordsList = [{ lat: coords.lat, lng: coords.lng }];
        const result = await callGAS("testLocationWithAuth", [idCode, coordsList]);
        if (result.status === "success") {
          elements.responseDiv.innerHTML = result.html ? `<div class="table-responsive">${result.html}</div>` : "無資料";
          elements.responseDiv.classList.add("show");
          startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
          enableAllButtonsExcept(button);
        } else {
          displayError(result.message);
          startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
          enableAllButtonsExcept(button);
        }
      } catch (err) {
        displayError(`測試失敗: ${err.message}`);
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
      }
    }, 300);
    // 查詢記錄
    const queryTodayRecords = debounce(async (button) => {
      disableAllButtons();
      const idCode = elements.idInput.value;
      if (!validateIdCode(idCode)) {
        displayError("請輸入完整的身分證後四碼");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
        return;
      }
      if (!navigator.onLine) {
        displayError("離線無法查詢");
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
        return;
      }
      displayLoading("查詢中｜請稍候...");
      try {
        const result = await callGAS("queryTodayRecords", [idCode]);
        if (result.status === "success") {
          elements.responseDiv.innerHTML = result.html ? `<div class="table-responsive">${result.html}</div>` : "無資料";
          elements.responseDiv.classList.add("show");
          startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
          enableAllButtonsExcept(button);
        } else {
          displayError(result.message);
          startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
          enableAllButtonsExcept(button);
        }
      } catch (err) {
        displayError(`查詢失敗: ${err.message}`);
        startIndividualCooldown(button, COOLDOWN_MS, button.dataset.originalText);
        enableAllButtonsExcept(button);
      }
    }, 300);
    // 影片教學控制
    function showVideoTutorialModal() {
      elements.videoTutorialModal.style.display = "flex";
      elements.tutorialVideo.play().catch(() => elements.videoFallback.style.display = "block");
    }
    function hideVideoTutorialModal() {
      elements.videoTutorialModal.style.display = "none";
      elements.tutorialVideo.pause();
      elements.videoFallback.style.display = "none";
    }
    
    // 表單模態框元素
    const formApplicationModal = document.getElementById("formApplicationModal");
    const closeFormModal = document.getElementById("closeFormModal");
    const overtimeForm = document.getElementById("overtimeForm");
    const cardCorrectionForm = document.getElementById("cardCorrectionForm");
    const leaveRequestForm = document.getElementById("leaveRequestForm");
    
    // 顯示表單選擇模態框
    function showFormApplicationModal() {
      formApplicationModal.classList.add("show");
      formApplicationModal.classList.add("form-overlay");
    }
    
    // 隱藏表單選擇模態框
    function hideFormApplicationModal() {
      formApplicationModal.classList.remove("show");
      formApplicationModal.classList.remove("form-overlay");
    }
    
    // 事件監聽
    function setupEventListeners() {
      elements.toggleBtn.addEventListener("click", () => {
        elements.idInput.type = elements.idInput.type === "password" ? "text" : "password";
        elements.eyeIcon.textContent = elements.idInput.type === "password" ? "visibility" : "visibility_off";
        elements.idInput.focus();
      });
      elements.idInput.addEventListener("input", () => {
        if (!/^\d*$/.test(elements.idInput.value)) {
          elements.idInput.value = elements.idInput.value.replace(/\D/g, "");
          elements.errorSpan.textContent = "只允許輸入 4 位數字";
          elements.errorSpan.classList.add("show");
        } else {
          elements.errorSpan.textContent = "";
          elements.errorSpan.classList.remove("show");
        }
        elements.idInput.setCustomValidity(elements.idInput.value.length !== 4 ? "必須輸入 4 位數" : "");
        if (validateIdCode(elements.idInput.value)) enableAllButtons();
        else disableAllButtons();
      });
      elements.idInput.addEventListener("blur", () => {
        elements.errorSpan.textContent = "";
        elements.errorSpan.classList.remove("show");
        elements.idInput.setCustomValidity(elements.idInput.value.length !== 4 ? "必須輸入 4 位數" : "");
      });
      elements.closeVideoModal.addEventListener("click", hideVideoTutorialModal);
      elements.tutorialVideo.addEventListener("error", () => {
        elements.tutorialVideo.style.display = "none";
        elements.videoFallback.style.display = "block";
      });
      elements.confirmIncognito.addEventListener("click", () => elements.incognitoPrompt.style.display = "none");
      elements.cancelIncognito.addEventListener("click", () => {
        alert("您已取消，無法進入系統！");
        window.location.href = "about:blank";
      });
      elements.allButtons.btnOn.addEventListener("click", () => startClockAction("上班", false, elements.allButtons.btnOn));
      elements.allButtons.btnOff.addEventListener("click", () => startClockAction("下班", false, elements.allButtons.btnOff));
      elements.allButtons.btnQuery.addEventListener("click", () => queryTodayRecords(elements.allButtons.btnQuery));
      elements.allButtons.btnTest.addEventListener("click", () => testLocation(elements.allButtons.btnTest));
      
      // 表單申請按鈕事件
      document.getElementById("btnForm").addEventListener("click", () => {
        showFormApplicationModal();
      });
      
      closeFormModal.addEventListener("click", hideFormApplicationModal);
      
      // 點擊模態框外部區域關閉模態框
      formApplicationModal.addEventListener("click", (e) => {
        if (e.target === formApplicationModal) {
          hideFormApplicationModal();
        }
      });
      
      // 表單選項點擊事件
      overtimeForm.addEventListener("click", () => {
        showCustomConfirm("加班申請", "加班申請功能開發中，即將推出", () => {
          hideFormApplicationModal();
        });
      });
      
      cardCorrectionForm.addEventListener("click", () => {
        showCustomConfirm("補卡申請", "補卡申請功能開發中，即將推出", () => {
          hideFormApplicationModal();
        });
      });
      
      leaveRequestForm.addEventListener("click", () => {
        showCustomConfirm("請假申請", "請假申請功能開發中，即將推出", () => {
          hideFormApplicationModal();
        });
      });
    }
    // 定期檢查
    function startPeriodicChecks() {
      setInterval(validateStoredIDs, CONSISTENCY_CHECK_INTERVAL);
    }
    // 初始化
    function init() {
      recoverDeviceID();
      showSafariNotice();
      setupEventListeners();
      updateNetworkStatus();
      elements.incognitoPrompt.style.display = "flex";
      startPeriodicChecks();
      
      // 將新按鈕添加到allButtons對象中
      elements.allButtons.btnForm = document.getElementById("btnForm");
      originalButtonStyles.btnForm = 'linear-gradient(to right, #9c27b0 0%, #673ab7 100%)';
    }
    function recoverDeviceID() {
      const validID = localStorage.getItem(DEVICE_ID_KEY) || sessionStorage.getItem(DEVICE_ID_KEY) || getCookie(DEVICE_ID_KEY);
      if (validID) {
        saveDeviceID(validID);
        console.log('已恢復設備識別碼');
      }
    }
    window.addEventListener("load", init);
  </script>
</body>
</html>
