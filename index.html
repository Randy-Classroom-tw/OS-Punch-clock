<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>OS_Office_ANN</title>
  <meta name="viewport" content="width=device-width, initial-scale=0.7, maximum-scale=1.0, user-scalable=no" />
  
  <!-- 預加載關鍵資源 -->
  <link rel="preload" href="https://fonts.googleapis.com/icon?family=Material+Icons" as="style">
  <link rel="preload" href="https://i.imgur.com/7obx0vd.jpg" as="image" crossorigin="anonymous">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" as="style">
  
  <link rel="icon" type="image/png" sizes="32x32" href="https://i.imgur.com/7obx0vd.jpg">
  <link rel="apple-touch-icon" href="https://i.imgur.com/7obx0vd.jpg">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap">
  
  <!-- 關鍵CSS內聯，避免渲染阻塞 -->
  <style>
    :root {
      /* 系統主題色變量 */
      --color-bg-primary: #1a1a1a;
      --color-bg-secondary: rgba(20, 20, 20, 0.95);
      --color-bg-tertiary: rgba(40, 40, 40, 0.8);
      --color-text-primary: #e0e0e0;
      --color-text-secondary: #bbb;
      --color-text-success: #2ecc71;
      --color-text-error: #e74c3c;
      
      /* 按鈕顏色變量 */
      --btn-on-from: #28a745;
      --btn-on-to: #1e7e34;
      --btn-off-from: #e74c3c;
      --btn-off-to: #c0392b;
      --btn-query-from: #3498db;
      --btn-query-to: #2980b9;
      --btn-test-from: #f39c12;
      --btn-test-to: #e67e22;
      --btn-form-from: #9c27b0;
      --btn-form-to: #673ab7;
      --btn-disabled-from: #666;
      --btn-disabled-to: #555;
      
      /* 間距與尺寸變量 */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 20px;
      --spacing-xl: 30px;
      --border-radius-sm: 6px;
      --border-radius-md: 10px;
      --border-radius-lg: 12px;
    }
    
    input::-ms-reveal,
    input::-ms-clear { display: none !important; }
    input[type=password]::-webkit-textfield-decoration-container {
      visibility: hidden !important;
      pointer-events: none !important;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    body {
      background: linear-gradient(145deg, #0a0a0a, var(--color-bg-primary));
      font-family: 'Roboto Mono', monospace;
      color: var(--color-text-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      font-weight: 700;
      text-shadow: 1px 1px 2px #000;
    }
    .container {
      background: var(--color-bg-secondary);
      border: 2px solid #333;
      border-radius: var(--border-radius-lg);
      box-shadow: 0 8px 20px rgba(0,0,0,0.8), inset 0 2px 4px rgba(255,255,255,0.05);
      padding: 40px;
      max-width: 700px;
      width: 100%;
      text-align: center;
    }
    .logo {
      width: 120px;
      margin: 0 auto 20px;
      filter: drop-shadow(0 4px 4px rgba(0,0,0,0.6));
    }
    h1 {
      font-size: 36px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #fff;
      margin-bottom: 10px;
    }
    h2 {
      font-size: 20px;
      color: var(--color-text-secondary);
      margin-bottom: 30px;
    }
    form {
      background: var(--color-bg-tertiary);
      border: 1px solid #333;
      border-radius: var(--border-radius-md);
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.7);
    }
    label {
      display: block;
      font-size: 18px;
      margin-bottom: 10px;
      color: #ccc;
    }
    .input-group {
      position: relative;
      margin-bottom: 8px;
    }
    input[type="password"],
    input[type="text"],
    input[type="tel"] {
      width: 100%;
      font-size: 20px;
      padding: 14px 50px 14px 16px;
      border: none;
      border-radius: var(--border-radius-sm);
      background-color: #222;
      color: #fff;
      text-align: center;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
      transition: background 0.3s, box-shadow 0.3s;
    }
    input:focus {
      background-color: #333;
      box-shadow: 0 0 8px rgba(0,176,255,0.6), inset 0 2px 6px rgba(0,0,0,0.5);
    }
    .toggle-btn {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: #aaa;
      font-size: 22px;
      cursor: pointer;
      transition: color 0.3s;
    }
    .toggle-btn:hover { color: #fff; }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      justify-content: center;
      margin-bottom: 20px;
    }
    .btn {
      flex: 1 1 120px;
      padding: 12px;
      font-size: 18px;
      border: none;
      border-radius: var(--border-radius-md);
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.6), inset 0 -2px 0 rgba(0,0,0,0.2);
      color: #fff;
      background-size: 100% 100%;
      transition: none;
    }
    .btn:hover { transform: translateY(-3px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(to right, var(--btn-disabled-from), var(--btn-disabled-to));
    }
    .btn-on { background: linear-gradient(to right, var(--btn-on-from) 0%, var(--btn-on-to) 100%); }
    .btn-off { background: linear-gradient(to right, var(--btn-off-from) 0%, var(--btn-off-to) 100%); }
    .btn-query { background: linear-gradient(to right, var(--btn-query-from) 0%, var(--btn-query-to) 100%); }
    .btn-test { background: linear-gradient(to right, var(--btn-test-from) 0%, var(--btn-test-to) 100%); }
    .btn-form { background: linear-gradient(to right, var(--btn-form-from) 0%, var(--btn-form-to) 100%); }
    
    #response {
      margin-top: 10px;
      font-size: 16px;
      background: rgba(0,0,0,0.4);
      border-radius: var(--border-radius-sm);
      padding: 10px;
      min-height: 40px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.7);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      color: #76ff03;
      overflow-x: auto;
    }
    #response.show {
      opacity: 1;
      transform: translateY(0);
    }
    #response table {
      width: 100%;
      min-width: 400px;
      border-collapse: collapse;
      text-align: center;
      border: 1px solid #555;
      font-size: 14px;
    }
    #response th, #response td {
      padding: 4px;
      border: 1px solid #666;
      white-space: nowrap;
    }
    .loading {
      font-size: 16px;
      color: #ff4444;
      animation: blink 1s infinite;
    }
    .loading::before {
      content: "";
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 3px solid #ccc;
      border-radius: 50%;
      border-top-color: #09f;
      animation: spin 0.8s infinite linear;
      vertical-align: middle;
      margin-right: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.75);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .overlay.show { display: flex; }
    .modal {
      background: #222;
      padding: 24px;
      border-radius: var(--border-radius-md);
      width: 90%;
      max-width: 400px;
      color: #fff;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.8);
    }
    .modal h3 {
      font-size: 24px;
      margin-bottom: 12px;
      letter-spacing: 1px;
    }
    .modal p {
      font-size: 18px;
      margin-bottom: 20px;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: space-evenly;
    }
    .modal .btn {
      flex: 1;
      padding: 10px;
      border-radius: var(--border-radius-sm);
      font-size: 20px;
      font-family: 'Roboto Mono', monospace;
      cursor: pointer;
      transition: background 0.3s, transform 0.3s;
      box-shadow: none;
      border: none;
    }
    .btn-confirm { background: var(--btn-on-from); color: #fff; }
    .btn-cancel { background: var(--btn-off-from); color: #fff; }
    .btn-confirm:hover { background: var(--btn-on-to); }
    .btn-cancel:hover { background: var(--btn-off-to); }
    #incognitoPrompt {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    #incognitoPrompt .prompt-content {
      background: #222;
      border: 2px solid #444;
      border-radius: var(--border-radius-md);
      padding: 20px 30px;
      text-align: center;
      max-width: 450px;
      width: 90%;
    }
    #incognitoPrompt h2 {
      margin-bottom: 20px;
      color: #fff;
      font-size: 24px;
    }
    #incognitoPrompt p {
      margin-bottom: 20px;
      font-size: 18px;
      color: #ddd;
    }
    #incognitoPrompt .button-group {
      display: flex;
      gap: var(--spacing-md);
      justify-content: center;
    }
    #incognitoPrompt .button-group button {
      font-family: 'Roboto Mono', monospace;
      flex: 1;
      min-width: 120px;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background 0.3s;
    }
    #confirmIncognito { background-color: var(--btn-on-from); color: #fff; }
    #confirmIncognito:hover { background-color: var(--btn-on-to); }
    #cancelIncognito { background-color: var(--btn-off-from); color: #fff; }
    #cancelIncognito:hover { background-color: var(--btn-off-to); }
    #videoTutorialModal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 11000;
      padding: 20px;
    }
    #videoTutorialModal .video-content {
      background: #222;
      border: 2px solid #444;
      border-radius: var(--border-radius-md);
      padding: 20px;
      text-align: center;
      max-width: 600px;
      width: 100%;
      position: relative;
    }
    #videoTutorialModal video {
      width: 100%;
      height: auto;
      border-radius: var(--border-radius-sm);
    }
    #videoTutorialModal .fallback-link {
      display: none;
      margin-top: 10px;
      color: #76ff03;
      font-size: 18px;
    }
    #videoTutorialModal .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 24px;
      cursor: pointer;
    }
    .network-status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      z-index: 999;
      transition: all 0.3s ease;
    }
    .network-online { background-color: rgba(40, 167, 69, 0.8); color: #fff; }
    .network-offline { background-color: rgba(220, 53, 69, 0.8); color: #fff; }
    .error-message {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      color: red;
      font-size: 14px;
      display: none;
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .error-message.show { display: block; opacity: 1; }
    .browser-notice {
      padding: var(--spacing-sm) var(--spacing-md);
      background-color: rgba(255, 193, 7, 0.2);
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      margin-bottom: var(--spacing-md);
      text-align: center;
      display: none;
    }
    .browser-notice.show { display: block; }
    
    /* 表單模態框樣式 */
    .form-modal {
      background: rgba(28, 28, 30, 0.95);
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      color: #fff;
      text-align: left;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
      animation: modalFadeIn 0.3s ease;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .form-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .form-modal-header h3 {
      font-size: 20px;
      margin: 0;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .close-form-btn {
      background: transparent;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .close-form-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    
    .form-modal-content {
      padding: 8px 0;
    }
    
    .form-item-container {
      display: flex;
      flex-direction: column;
    }
    
    .form-item {
      display: flex;
      align-items: center;
      padding: 16px 20px;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }
    
    .form-item:after {
      content: '';
      position: absolute;
      left: 20px;
      right: 20px;
      bottom: 0;
      height: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .form-item:last-child:after {
      display: none;
    }
    
    .form-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }
    
    .form-item:active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .form-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      flex-shrink: 0;
    }
    
    .form-icon .material-icons {
      font-size: 24px;
    }
    
    #overtimeForm .form-icon {
      color: #ff9800;
    }
    
    #cardCorrectionForm .form-icon {
      color: #03a9f4;
    }
    
    #leaveRequestForm .form-icon {
      color: #4caf50;
    }
    
    .form-info {
      flex: 1;
    }
    
    .form-info h4 {
      font-size: 17px;
      margin: 0 0 4px 0;
      font-weight: 600;
    }
    
    .form-info p {
      font-size: 14px;
      margin: 0;
      color: #999;
    }
    
    .form-arrow {
      color: #777;
    }
    
    /* 對話框背景模糊效果 */
    .overlay.show.form-overlay {
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
    }
    
    /* 骨架屏動畫 */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .skeleton-loader {
      background: linear-gradient(to right, #333 8%, #444 18%, #333 33%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite linear;
      border-radius: 4px;
    }
    
    /* 按鈕冷卻的CSS變量 */
    .btn-cooldown {
      --progress: 0%;
      background-image: linear-gradient(to right, var(--color-from) 0%, var(--color-to) var(--progress), #666 var(--progress), #555 100%) !important;
      transition: --progress 0.3s linear;
    }
    
    /* iOS Safari 特殊樣式 */
    .ios-warning {
      background-color: rgba(255, 235, 59, 0.1);
      border-left: 3px solid #ffeb3b;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      font-size: 14px;
      color: #ffeb3b;
      display: flex;
      align-items: center;
    }
    
    .ios-warning .material-icons {
      margin-right: 8px;
      font-size: 18px;
    }
    
    .ios-success {
      background-color: rgba(76, 175, 80, 0.1);
      border-left: 3px solid #4CAF50;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 4px;
      font-size: 14px;
      color: #4CAF50;
      display: flex;
      align-items: center;
    }
    
    .ios-success .material-icons {
      margin-right: 8px;
      font-size: 18px;
    }
    
    /* 脈衝按鈕樣式 */
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(33, 150, 243, 0); }
      100% { box-shadow: 0 0 0 0 rgba(33, 150, 243, 0); }
    }
    
    .btn-pulse {
      animation: pulse 1.5s infinite;
    }

    /* 位置重置按鈕樣式 */
    #resetLocationBtn {
      margin-top: 10px;
      padding: 8px 15px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Roboto Mono', monospace;
      font-size: 14px;
      transition: background-color 0.3s;
    }
    
    #resetLocationBtn:hover {
      background: #1976D2;
    }
    
    #resetLocationBtn:active {
      background: #0D47A1;
    }
  </style>
</head>

<body>
  <div id="networkStatus" class="network-status network-online">已連線</div>
  <div class="container">
    <img class="logo" src="https://i.imgur.com/7obx0vd.jpg" alt="Logo" crossorigin="anonymous">
    <h1>OS_Office_ANN</h1>
    <h2>請輸入身分證後四碼執行打卡</h2>
    <div id="safariNotice" class="browser-notice">
      <p>若遇到打卡問題｜請截圖回報營運組</p>
    </div>
    <form id="idForm">
      <label for="idCode">請點擊下方框內輸入後四碼</label>
      <div class="input-group">
        <input 
          type="password" 
          id="idCode" 
          name="idCode" 
          required 
          pattern="\d{4}" 
          maxlength="4" 
          inputmode="numeric"
          autocomplete="off" 
          autocorrect="off" 
          autocapitalize="off" 
          spellcheck="false"
        />
        <button type="button" class="toggle-btn" id="toggleBtn" aria-label="切換密碼顯示">
          <span class="material-icons" id="eyeIcon">visibility</span>
        </button>
        <span class="error-message"></span>
      </div>
    </form>
    <div class="btn-group">
      <button type="button" class="btn btn-on" id="btnOn" data-original-text="上班" disabled>上班</button>
      <button type="button" class="btn btn-off" id="btnOff" data-original-text="下班" disabled>下班</button>
      <button type="button" class="btn btn-query" id="btnQuery" data-original-text="查詢記錄" disabled>查詢記錄</button>
      <button type="button" class="btn btn-test" id="btnTest" data-original-text="測試定位" disabled>測試定位</button>
      <button type="button" class="btn btn-form" id="btnForm" data-original-text="各項表單申請" disabled>各項表單申請</button>
    </div>
    <div id="response" role="status" aria-live="polite"></div>
  </div>
  
  <!-- 打卡確認模態框 -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h3 id="modal-title">提示</h3>
      <p id="modal-message">提示訊息</p>
      <div class="modal-buttons">
        <button id="modal-confirm" class="btn btn-confirm">確定</button>
        <button id="modal-cancel" class="btn btn-cancel">取消</button>
      </div>
    </div>
  </div>
  
  <!-- 無痕模式提示 (替換後的版本) -->
  <div id="incognitoPrompt">
    <div class="prompt-content">
      <h2>系統提示</h2>
      <p>請確保關閉無痕瀏覽器模式後再執行</p>
      
      <!-- 新增進度顯示區域 -->
      <div id="resetProgressContainer" style="width:100%; margin:15px 0; background-color:#333; border-radius:4px; overflow:hidden; display:none;">
        <div id="resetProgress" style="height:6px; width:0%; background:linear-gradient(to right, #4CAF50, #8BC34A); transition:width 0.3s ease; border-radius:4px;"></div>
        <div id="resetStatusText" style="font-size:14px; color:#aaa; margin-top:8px; text-align:center;">準備中...</div>
      </div>
      
      <div class="button-group">
        <button id="confirmIncognito">我已確認關閉</button>
        <button id="cancelIncognito">取消</button>
      </div>
    </div>
  </div>
  
  <!-- 影片教學模態框 -->
  <div id="videoTutorialModal">
    <div class="video-content">
      <button class="close-btn" id="closeVideoModal">×</button>
      <video id="tutorialVideo" controls>
        <source src="https://i.imgur.com/Wnemzxu.mp4" type="video/mp4">
        您的瀏覽器不支援影片播放，請點此觀看：
        <a href="https://i.imgur.com/Wnemzxu.mp4" target="_blank">https://i.imgur.com/Wnemzxu.mp4</a>
      </video>
      <div class="fallback-link" id="videoFallback">
        <a href="https://i.imgur.com/Wnemzxu.mp4" target="_blank">無法播放影片？請點此觀看</a>
      </div>
    </div>
  </div>
  
  <!-- iOS Safari特殊說明區塊 -->
  <div id="iosSafariInfoModal" class="overlay" style="display:none;">
    <div class="modal">
      <h3>iOS Safari 使用提示</h3>
      <div style="text-align:left; margin-bottom:15px;">
        <p style="margin-bottom:10px;">由於iOS Safari在位置定位方面的特殊性，我們提供以下建議以獲得最佳打卡體驗：</p>
        <ol style="padding-left:20px; margin-bottom:10px;">
          <li style="margin-bottom:5px;">保持良好的網路連接(WiFi或4G/5G)</li>
          <li style="margin-bottom:5px;">確保在「設定 > Safari > 位置服務」已開啟</li>
          <li style="margin-bottom:5px;">若定位不準確，請嘗試重新啟動Safari或切換網路</li>
          <li style="margin-bottom:5px;">定位前請稍等片刻，讓系統獲取更穩定的位置</li>
        </ol>
        <p style="font-weight:bold; color:#4CAF50;">系統已自動為iOS Safari用戶啟用位置優化功能</p>
      </div>
      <div class="modal-buttons">
        <button id="iosSafariInfoConfirm" class="btn btn-confirm">我已了解</button>
      </div>
    </div>
  </div>
  
  <!-- 表單申請模態框 -->
  <div id="formApplicationModal" class="overlay">
    <div class="form-modal">
      <div class="form-modal-header">
        <h3>各項表單申請</h3>
        <button id="closeFormModal" class="close-form-btn">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="form-modal-content">
        <div class="form-item-container">
          <div class="form-item" id="overtimeForm">
            <div class="form-icon">
              <span class="material-icons">schedule</span>
            </div>
            <div class="form-info">
              <h4>加班申請</h4>
              <p>提交加班時數及原因</p>
            </div>
            <div class="form-arrow">
              <span class="material-icons">chevron_right</span>
            </div>
          </div>
          
          <div class="form-item" id="cardCorrectionForm">
            <div class="form-icon">
              <span class="material-icons">credit_card</span>
            </div>
            <div class="form-info">
              <h4>補卡申請</h4>
              <p>忘記打卡或打卡錯誤</p>
            </div>
            <div class="form-arrow">
              <span class="material-icons">chevron_right</span>
            </div>
          </div>
          
          <div class="form-item" id="leaveRequestForm">
            <div class="form-icon">
              <span class="material-icons">event_busy</span>
            </div>
            <div class="form-info">
              <h4>請假申請</h4>
              <p>請假日期及假別選擇</p>
            </div>
            <div class="form-arrow">
              <span class="material-icons">chevron_right</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /**
   * @fileoverview OS辦公室出勤系統前端腳本 (完整版本)
   * @version 1.0.6
   * @author OS系統團隊
   */

  /* ====================================
     1) 先宣告 (函式、工具、模組)
  =====================================*/

  /**
   * iOS Safari定位修復常數
   * @constant {Object}
   */
  const IOS_SAFARI_FIX = {
    OUTLIER_DISTANCE_THRESHOLD: 1000,  // 異常座標距離閾值 (公尺) - 超過視為爆衝
    EXTRA_SAFETY_MARGIN: 15,           // 額外安全邊界 (公尺)
    STRICTER_ACCURACY_VALUE: 35,       // 更嚴格的精度閾值 (公尺)
    MAX_COORDINATES_AGE: 90000,        // 座標最大年齡 (毫秒)
    MIN_SAMPLE_COUNT: 2,               // 最少樣本數量
    RESET_INTERVAL: 3000,              // 位置服務重置間隔 (毫秒)
    CACHE_CLEAR_DELAY: 500             // 快取清理延遲 (毫秒)
  };

  /**
   * 防抖動函數
   */
  function debounce(func, wait) {
    let timeout;
    return function (...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  /**
   * 檢查 4 位數字
   */
  function validateIdCode(idCode) {
    return /^\d{4}$/.test(idCode);
  }

  /**
   * 按鈕狀態管理器
   */
  const ButtonStateManager = {
    // 追蹤正在冷卻中的按鈕
    coolingButtons: new Set(),
    
    // 追蹤操作狀態
    operationInProgress: false,
    
    // 將按鈕添加到冷卻集合
    addToCooling: function(buttonId) {
      this.coolingButtons.add(buttonId);
    },
    
    // 從冷卻集合中移除按鈕
    removeFromCooling: function(buttonId) {
      this.coolingButtons.delete(buttonId);
    },
    
    // 檢查按鈕是否正在冷卻
    isButtonCooling: function(buttonId) {
      return this.coolingButtons.has(buttonId);
    },
    
    // 設置操作狀態
    setOperationStatus: function(inProgress) {
      this.operationInProgress = inProgress;
    },
    
    // 重置所有狀態（緊急情況使用）
    resetAll: function() {
      this.coolingButtons.clear();
      this.operationInProgress = false;
    }
  };

  /**
   * 瀏覽器相關工具
   */
  const BrowserUtils = {
    isSafari: () => {
      const ua = navigator.userAgent.toLowerCase();
      return /safari/.test(ua) && !/chrome/.test(ua);
    },
    showSafariNotice: () => {
      if (BrowserUtils.isSafari()) {
        elements.safariNotice.classList.add('show');
      }
    },
    parseBrowser: (userAgent) => {
      const ua = userAgent.toLowerCase();
      if (/edg\//.test(ua)) return "Edge";
      if (/chrome\//.test(ua)) return "Chrome";
      if (/safari\//.test(ua) && !/chrome\//.test(ua)) return "Safari";
      if (/firefox\//.test(ua)) return "Firefox";
      if (/opera\//.test(ua) || /opr\//.test(ua)) return "Opera";
      if (/trident\//.test(ua)) return "Internet Explorer";
      return "未知瀏覽器";
    },
    getWebGLFingerprint: () => {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl');
        if (!gl) return 'WebGL not supported';
        const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
        if (debugInfo) {
          const vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) || 'unknown_vendor';
          const renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) || 'unknown_renderer';
          return `${vendor}-${renderer}`;
        }
        return 'No debug info';
      } catch (err) {
        console.error("WebGL 指紋失敗:", err);
        return 'WebGL error';
      }
    },
    detectCommonFonts: () => {
      const fontList = [
        'Arial','Times New Roman','Courier New','Georgia',
        'Verdana','Helvetica','Tahoma','Trebuchet MS'
      ];
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      if (!context) return "canvas_unsupported";
      const testString = "abcdefghijklmnopqrstuvwxyz123456789";
      context.font = "72px monospace";
      const baselineSize = context.measureText(testString).width;
      const detectedFonts = fontList.filter(font => {
        context.font = `72px '${font}', monospace`;
        return context.measureText(testString).width !== baselineSize;
      });
      return detectedFonts.length > 0 ? detectedFonts.join('|').substring(0, 100) : "no_fonts_detected";
    }
  };

  /**
   * 儲存相關工具
   */
  const StorageUtils = {
    getCookie: (name) => {
      const nameEQ = name + "=";
      const ca = document.cookie.split(';');
      for (let i=0; i<ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length);
      }
      return null;
    },
    setCookie: (name, value, days) => {
      try {
        const date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = `${name}=${value};${expires};path=/;SameSite=Strict`;
        return true;
      } catch(e) {
        console.error("設置 Cookie 失敗:", e);
        return false;
      }
    }
  };

  /**
   * 加密與識別碼工具
   */
  const CryptoUtils = {
    generateFallbackID: () => {
      if (crypto && typeof crypto.randomUUID === 'function') {
        return crypto.randomUUID();
      }
      return 'xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random()*16|0;
        const v = (c === 'x') ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    },
    hashString: async (str) => {
      try {
        if (!str) throw new Error("無法雜湊空字串");
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2,"0")).join("");
      } catch(err) {
        console.error("雜湊函數失敗:", err);
        return CryptoUtils.generateFallbackID();
      }
    }
  };

  /**
   * 網路相關工具 (JSONP)
   */
  const NetworkUtils = {
    getIPAddress: async () => {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        const response = await fetch('https://api.ipify.org?format=json', {signal: controller.signal});
        clearTimeout(timeoutId);
        if (!response.ok) throw new Error(`網路錯誤: ${response.status}`);
        const data = await response.json();
        return data.ip;
      } catch(err) {
        console.error("無法獲取 IP:", err);
        return 'unknown';
      }
    },
    updateNetworkStatus: () => {
      if (navigator.onLine) {
        elements.networkStatus.textContent = "已連線";
        elements.networkStatus.className = "network-status network-online";
      } else {
        elements.networkStatus.textContent = "離線";
        elements.networkStatus.className = "network-status network-offline";
        UIUtils.displayError("網路連線已中斷");
      }
    },
    callGAS: async (functionName, parametersArray) => {
      return new Promise((resolve, reject) => {
        try {
          const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substring(2,10);
          window[callbackName] = (data) => {
            console.log(`JSONP回調成功: ${functionName}`, data.status||'未知狀態');
            if (script.parentNode) script.parentNode.removeChild(script);
            delete window[callbackName];
            resolve(data);
          };
          const params = new URLSearchParams({
            function: functionName,
            parameters: JSON.stringify(parametersArray),
            callback: callbackName
          });
          const fullUrl = `${WEB_APP_URL}?${params.toString()}`;
          console.log(`發起JSONP請求: ${functionName}`);
          const script = document.createElement('script');
          script.src = fullUrl;
          script.async = true;
          script.onerror = (e) => {
            console.error(`JSONP請求失敗: ${functionName}`, e);
            if (script.parentNode) script.parentNode.removeChild(script);
            delete window[callbackName];
            reject(new Error('JSONP 請求失敗 - 請檢查網路連接'));
          };
          const timeout = setTimeout(() => {
            if (script.parentNode) script.parentNode.removeChild(script);
            delete window[callbackName];
            console.warn(`JSONP請求超時: ${functionName}`);
            reject(new Error('請求超時 - 伺服器回應過慢'));
          }, CONFIG.API_TIMEOUT);
          script.onload = () => clearTimeout(timeout);
          document.head.appendChild(script);
        } catch(err) {
          console.error("構建JSONP請求失敗:", err);
          reject(new Error(`請求建立失敗: ${err.message}`));
        }
      });
    },
    callGASWithRetry: async (functionName, parametersArray, retries=CONFIG.JSONP_RETRY_COUNT) => {
      try {
        return await NetworkUtils.callGAS(functionName, parametersArray);
      } catch(error) {
        if (retries <= 0) throw error;
        console.log(`JSONP請求失敗，將在${CONFIG.JSONP_RETRY_DELAY}ms後重試 (剩餘重試次數: ${retries})`);
        await new Promise(resolve => setTimeout(resolve, CONFIG.JSONP_RETRY_DELAY));
        return NetworkUtils.callGASWithRetry(functionName, parametersArray, retries-1);
      }
    },
    checkJSONPError: (response) => {
      return !response || (response.error && response.status === 'error');
    }
  };

/**
   * UI 介面工具
   */
  const UIUtils = {
    displayError: (msg) => {
      elements.responseDiv.innerHTML = `<div style="color:red; text-align:center;">${msg}</div>`;
      elements.responseDiv.classList.add("show");
    },
    displaySuccess: (msg) => {
      elements.responseDiv.innerHTML = `<div style="color:green; font-weight:bold; text-align:center;">${msg}</div>`;
      elements.responseDiv.classList.add("show");
    },
    displayLoading: (msg) => {
      elements.responseDiv.innerHTML = `<span class="loading">${msg || "載入中｜請稍候..."}</span>`;
      elements.responseDiv.classList.add("show");
    },
    clearResponse: () => {
      elements.responseDiv.innerHTML = "";
      elements.responseDiv.classList.remove("show");
    },
    disableAllButtons: () => {
      // 設置操作狀態為進行中
      ButtonStateManager.setOperationStatus(true);
      
      Object.values(elements.allButtons).forEach(button => {
        button.disabled = true;
        // 如果按鈕不在冷卻中，才改變其樣式
        if (!ButtonStateManager.isButtonCooling(button.id)) {
          button.style.background = 'linear-gradient(to right, var(--btn-disabled-from), var(--btn-disabled-to))';
        }
      });
    },
    enableAllButtons: () => {
      // 設置操作狀態為結束
      ButtonStateManager.setOperationStatus(false);
      
      Object.values(elements.allButtons).forEach(button => {
        // 只有不在冷卻中的按鈕才啟用
        if (!ButtonStateManager.isButtonCooling(button.id)) {
          button.disabled = false;
          button.style.background = originalButtonStyles[button.id];
        }
      });
    },
    enableAllButtonsExcept: (buttonToExclude) => {
      // 設置操作狀態為結束
      ButtonStateManager.setOperationStatus(false);
      
      Object.values(elements.allButtons).forEach(button => {
        if (button.id !== buttonToExclude.id && !ButtonStateManager.isButtonCooling(button.id)) {
          button.disabled = false;
          button.style.background = originalButtonStyles[button.id];
        }
      });
    },
    startIndividualCooldown: (button, duration, originalText) => {
      button.disabled = true;
      button.textContent = originalText;
      const btnId = button.id;
      
      // 標記按鈕為冷卻狀態
      ButtonStateManager.addToCooling(btnId);
      
      const colorFrom = buttonColors[btnId]?.from || 'var(--btn-disabled-from)';
      const colorTo = buttonColors[btnId]?.to || 'var(--btn-disabled-to)';
      button.style.setProperty('--color-from', colorFrom);
      button.style.setProperty('--color-to', colorTo);
      button.style.setProperty('--progress', '0%');
      button.classList.add('btn-cooldown');
      button.style.background = `linear-gradient(to right, ${colorFrom} 0%, ${colorTo} 0%, var(--btn-disabled-from) 0%, var(--btn-disabled-to) 100%)`;
      
      const startTime = performance.now();
      function updateProgress(timestamp) {
        const elapsed = timestamp - startTime;
        const progress = Math.min((elapsed / duration) * 100, 100);
        button.style.setProperty('--progress', `${progress}%`);
        
        if (progress < 100) {
          requestAnimationFrame(updateProgress);
        } else {
          button.classList.remove('btn-cooldown');
          button.style.background = originalButtonStyles[btnId];
          // 只有在沒有操作進行時才啟用
          button.disabled = ButtonStateManager.operationInProgress;
          // 從冷卻集合中移除
          ButtonStateManager.removeFromCooling(btnId);
        }
      }
      
      requestAnimationFrame(updateProgress);
    },
    showCustomConfirm: (title, message, onConfirm, onCancel) => {
      elements.modalTitle.textContent = title || "提示";
      elements.modalMessage.textContent = message;
      elements.overlay.classList.add("show");
      elements.confirmBtn.onclick = () => {
        elements.overlay.classList.remove("show");
        if (onConfirm) onConfirm();
      };
      elements.cancelBtn.onclick = () => {
        elements.overlay.classList.remove("show");
        if (onCancel) onCancel();
      };
    },
    displayIOSMessage: function(message) {
      if (!elements.responseDiv) return;
      
      elements.responseDiv.innerHTML = `
        <div style="color:#ffeb3b; background-color:rgba(0,0,0,0.2); padding:8px; border-radius:4px; margin-bottom:8px; border-left:3px solid #ffeb3b;">
          <span style="display:inline-flex; align-items:center;">
            <span class="material-icons" style="margin-right:8px; font-size:18px;">warning</span>
            ${message}
          </span>
        </div>
      ` + elements.responseDiv.innerHTML;
      
      elements.responseDiv.classList.add("show");
    }
  };

  /**
   * 裝置識別碼管理
   */
  const DeviceIdManager = {
    saveDeviceId: (deviceId) => {
      if (!deviceId) {
        console.error("嘗試儲存空的設備識別碼");
        return false;
      }
      let successCount = 0;
      const timestamp = Date.now().toString();
      try {
        localStorage.setItem(CONFIG.DEVICE_ID_KEY, deviceId);
        localStorage.setItem(`${CONFIG.DEVICE_ID_KEY}_timestamp`, timestamp);
        localStorage.setItem(`${CONFIG.DEVICE_ID_KEY}_version`, CONFIG.APP_VERSION);
        successCount++;
      } catch(e) {
        console.warn("無法儲存到 localStorage:", e);
      }
      try {
        sessionStorage.setItem(CONFIG.DEVICE_ID_KEY, deviceId);
        sessionStorage.setItem(`${CONFIG.DEVICE_ID_KEY}_timestamp`, timestamp);
        successCount++;
      } catch(e) {
        console.warn("無法儲存到 sessionStorage:", e);
      }
      if (StorageUtils.setCookie(CONFIG.DEVICE_ID_KEY, deviceId, 365)) {
        successCount++;
      }
      return successCount > 0;
    },
    validateStoredIds: () => {
      const localId = localStorage.getItem(CONFIG.DEVICE_ID_KEY);
      const sessionId = sessionStorage.getItem(CONFIG.DEVICE_ID_KEY);
      const cookieId = StorageUtils.getCookie(CONFIG.DEVICE_ID_KEY);
      let primaryId = null;
      let needsRepair = false;
      if (localId) {
        primaryId = localId;
        const storedVersion = localStorage.getItem(`${CONFIG.DEVICE_ID_KEY}_version`);
        if (storedVersion !== CONFIG.APP_VERSION) {
          localStorage.setItem(`${CONFIG.DEVICE_ID_KEY}_version`, CONFIG.APP_VERSION);
        }
      } else if (cookieId) {
        primaryId = cookieId;
        needsRepair = true;
      } else if (sessionId) {
        primaryId = sessionId;
        needsRepair = true;
      }
      if (primaryId && (primaryId!==localId || primaryId!==sessionId || primaryId!==cookieId)) {
        needsRepair = true;
      }
      if (primaryId && needsRepair) {
        console.log("檢測到識別碼不一致，正在修復...");
        DeviceIdManager.saveDeviceId(primaryId);
        return true;
      }
      return false;
    },
    getDeviceUuid: async () => {
      const storedId = localStorage.getItem(CONFIG.DEVICE_ID_KEY) ||
                       sessionStorage.getItem(CONFIG.DEVICE_ID_KEY) ||
                       StorageUtils.getCookie(CONFIG.DEVICE_ID_KEY);
      if (storedId) {
        DeviceIdManager.validateStoredIds();
        return storedId;
      }
      try {
        const stableFeatures = [
          navigator.platform || '',
          `${screen.width}x${screen.height}`,
          navigator.language || '',
          screen.colorDepth || 0,
          navigator.userAgent.substring(0,100)
        ];
        if (!BrowserUtils.isSafari()) {
          stableFeatures.push(navigator.hardwareConcurrency || 0);
          stableFeatures.push(window.devicePixelRatio || 0);
          stableFeatures.push(BrowserUtils.getWebGLFingerprint());
        }
        const ip = await NetworkUtils.getIPAddress().catch(()=> 'unknown');
        stableFeatures.push(ip);
        const deviceFingerprint = stableFeatures.join('|');
        const newId = await CryptoUtils.hashString(deviceFingerprint)
          .catch(()=> CryptoUtils.generateFallbackID());
        DeviceIdManager.saveDeviceId(newId);
        return newId;
      } catch(err) {
        console.error("生成設備識別碼失敗:", err);
        const fallbackId = CryptoUtils.generateFallbackID();
        DeviceIdManager.saveDeviceId(fallbackId);
        return fallbackId;
      }
    },
    recoverDeviceId: () => {
      const validId = localStorage.getItem(CONFIG.DEVICE_ID_KEY) ||
                      sessionStorage.getItem(CONFIG.DEVICE_ID_KEY) ||
                      StorageUtils.getCookie(CONFIG.DEVICE_ID_KEY);
      if (validId) {
        DeviceIdManager.saveDeviceId(validId);
        console.log('已恢復設備識別碼');
      }
    }
  };

  /**
   * 裝置資訊管理
   */
  const DeviceInfoManager = {
    collectDeviceInfo: () => {
      return {
        OS: navigator.platform || "未知",
        Browser: navigator.userAgent || "未知",
        ScreenResolution: `${window.screen.width}x${window.screen.height}`,
        TimeZone: Intl.DateTimeFormat().resolvedOptions().timeZone || "未知",
        Language: navigator.language || "未知",
        HardwareConcurrency: navigator.hardwareConcurrency || 0,
        DeviceMemory: navigator.deviceMemory || 0,
        MaxTouchPoints: navigator.maxTouchPoints || 0,
        ColorDepth: window.screen.colorDepth || 24,
        PixelRatio: window.devicePixelRatio || 1,
        IsSafari: BrowserUtils.isSafari(),
        TouchSupport: ('ontouchstart' in window) || (navigator.maxTouchPoints>0),
        AvailScreen: `${window.screen.availWidth}x${window.screen.availHeight}`,
        Fonts: BrowserUtils.detectCommonFonts(),
        AppVersion: CONFIG.APP_VERSION
      };
    },
    getUpdatedDeviceInfo: function() {
      const info = this.collectDeviceInfo();
      info.isIOSSafari = isIOSSafari();
      info.timestamp = Date.now();
      
      // 添加特定的iOS信息
      if (info.isIOSSafari) {
        const ua = navigator.userAgent;
        const iosVersion = (ua.match(/OS (\d+)_(\d+)_?(\d+)?/) || []).slice(1).join('.');
        const safariVersion = (ua.match(/Version\/(\d+)\.(\d+)(?:\.(\d+))?/) || []).slice(1).join('.');
        
        info.iosVersion = iosVersion || 'unknown';
        info.safariVersion = safariVersion || 'unknown';
        info.deviceCategory = /iPad/.test(ua) ? 'iPad' : 'iPhone';
      }
      
      return info;
    }
  };

  /**
   * @constant {string} WEB_APP_URL - 部署網址 (GAS)
   */
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwQz2Zrzn_QdNfELnr_4djA5T622UYxWhnN9m0oTHwMcHQK2NrbG-ayOKspevbAF3-K/exec";

  /**
   * @constant {Object} CONFIG
   */
  const CONFIG = {
    COOLDOWN_MS: 5000,
    CONSISTENCY_CHECK_INTERVAL: 30000,
    DEVICE_ID_KEY: 'OS_DEVICE_ID',
    APP_VERSION: '1.0.6',
    API_TIMEOUT: 20000, // 從 15000 增加到 20000，適應多座標處理
    JSONP_RETRY_COUNT: 2,
    JSONP_RETRY_DELAY: 1000
  };

  /**
   * 主要DOM元素
   */
  const elements = {
    toggleBtn: document.getElementById("toggleBtn"),
    idInput: document.getElementById("idCode"),
    eyeIcon: document.getElementById("eyeIcon"),
    responseDiv: document.getElementById("response"),
    overlay: document.getElementById("overlay"),
    modalTitle: document.getElementById("modal-title"),
    modalMessage: document.getElementById("modal-message"),
    confirmBtn: document.getElementById("modal-confirm"),
    cancelBtn: document.getElementById("modal-cancel"),
    incognitoPrompt: document.getElementById("incognitoPrompt"),
    confirmIncognito: document.getElementById("confirmIncognito"),
    cancelIncognito: document.getElementById("cancelIncognito"),
    videoTutorialModal: document.getElementById("videoTutorialModal"),
    closeVideoModal: document.getElementById("closeVideoModal"),
    tutorialVideo: document.getElementById("tutorialVideo"),
    videoFallback: document.getElementById("videoFallback"),
    networkStatus: document.getElementById("networkStatus"),
    errorSpan: document.querySelector(".error-message"),
    safariNotice: document.getElementById("safariNotice"),
    allButtons: {
      btnOn: document.getElementById("btnOn"),
      btnOff: document.getElementById("btnOff"),
      btnQuery: document.getElementById("btnQuery"),
      btnTest: document.getElementById("btnTest"),
      btnForm: document.getElementById("btnForm")
    }
  };

  /**
   * 原始按鈕樣式
   */
  const originalButtonStyles = {
    btnOn: 'linear-gradient(to right, #28a745 0%, #1e7e34 100%)',
    btnOff: 'linear-gradient(to right, #e74c3c 0%, #c0392b 100%)',
    btnQuery: 'linear-gradient(to right, #3498db 0%, #2980b9 100%)',
    btnTest: 'linear-gradient(to right, #f39c12 0%, #e67e22 100%)',
    btnForm: 'linear-gradient(to right, var(--btn-form-from) 0%, var(--btn-form-to) 100%)'
  };

  /**
   * 按鈕顏色配置
   */
  const buttonColors = {
    btnOn: { from: '#28a745', to: '#1e7e34' },
    btnOff: { from: '#e74c3c', to: '#c0392b' },
    btnQuery: { from: '#3498db', to: '#2980b9' },
    btnTest: { from: '#f39c12', to: '#e67e22' },
    btnForm: { from: '#9c27b0', to: '#673ab7' }
  };

/**
   * 計算兩個座標點之間的距離
   * @param {number} lat1 第一點緯度
   * @param {number} lng1 第一點經度
   * @param {number} lat2 第二點緯度
   * @param {number} lng2 第二點經度
   * @returns {number} 兩點之間的距離(公尺)
   */
  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371e3; // 地球半徑(公尺)
    const toRad = deg => deg * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
             Math.cos(toRad(lat1)) *
             Math.cos(toRad(lat2)) *
             Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  /**
   * 清除位置相關快取
   * @returns {Promise} 完成清除的Promise
   */
  function clearLocationCache() {
    return new Promise(resolve => {
      try {
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
              if (cacheName.includes('geolocation') || cacheName.includes('position')) {
                caches.delete(cacheName)
                  .then(() => console.log(`已清除位置快取: ${cacheName}`))
                  .catch(err => console.warn(`清除位置快取失敗: ${cacheName}`, err));
              }
            });
          }).catch(err => console.warn('快取清除失敗', err));
        }
        
        // 清除localStorage中可能的位置相關項目
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('geo') || 
                     key.includes('location') || 
                     key.includes('position') || 
                     key.includes('coord'))) {
            keysToRemove.push(key);
          }
        }
        
        keysToRemove.forEach(key => {
          try {
            localStorage.removeItem(key);
            console.log(`已移除localStorage項目: ${key}`);
          } catch (e) {
            console.warn(`移除localStorage項目失敗: ${key}`, e);
          }
        });
        
        // 確保清除任何sessionStorage項目
        try {
          for (let i = 0; i < sessionStorage.length; i++) {
            const key = sessionStorage.key(i);
            if (key && (key.includes('geo') || 
                       key.includes('location') || 
                       key.includes('position') || 
                       key.includes('coord'))) {
              sessionStorage.removeItem(key);
              console.log(`已移除sessionStorage項目: ${key}`);
            }
          }
        } catch (e) {
          console.warn('清除sessionStorage失敗', e);
        }
        
        // 延遲一下以確保清除完成
        setTimeout(() => {
          console.log('位置快取清除完成');
          resolve(true);
        }, IOS_SAFARI_FIX.CACHE_CLEAR_DELAY);
      } catch (err) {
        console.error('清除位置快取時出錯:', err);
        resolve(false); // 即使出錯也繼續
      }
    });
  }

  /**
   * 強制重新初始化位置服務
   * @returns {Promise} 重置完成的Promise
   */
  function forceGeolocationReset() {
    return new Promise(async (resolve) => {
      // 首先清除快取
      await clearLocationCache();
      
      if (!navigator.geolocation) {
        console.warn('瀏覽器不支援地理位置API');
        resolve(false);
        return;
      }
      
      try {
        const watchId = navigator.geolocation.watchPosition(
          () => {}, // 成功回調為空
          () => {}, // 錯誤回調為空
          { enableHighAccuracy: true, timeout: 1000, maximumAge: 0 }
        );
        
        // 立即清除 watchPosition
        if (watchId !== undefined) {
          navigator.geolocation.clearWatch(watchId);
        }
        
        // 發起一個故意會超時的請求，強制重置
        navigator.geolocation.getCurrentPosition(
          () => {}, // 成功回調為空
          () => {}, // 錯誤回調為空
          { enableHighAccuracy: true, timeout: 1, maximumAge: 0 }
        );
        
        // 延遲以確保重置有足夠時間生效
        setTimeout(() => {
          console.log('位置服務重置完成');
          resolve(true);
        }, IOS_SAFARI_FIX.RESET_INTERVAL);
      } catch (err) {
        console.error('重置位置服務時出錯:', err);
        resolve(false);
      }
    });
  }

  /**
   * 過濾位置樣本，移除異常值
   * @param {Array} samples 座標樣本數組
   * @returns {Array} 過濾後的座標數組
   */
  function filterLocationSamples(samples) {
    if (!samples || samples.length === 0) {
      return [];
    }
    
    if (samples.length === 1) {
      return samples;
    }
    
    // 按精確度排序(從高到低)
    const sortedSamples = [...samples].sort((a, b) => {
      const accuracyA = a.accuracy || 9999;
      const accuracyB = b.accuracy || 9999;
      return accuracyA - accuracyB;
    });
    
    // 找出精度最高的樣本作為參考點
    const reference = sortedSamples[0];
    
    // 篩選出距離參考點不超過閾值的樣本
    const validSamples = sortedSamples.filter(sample => {
      if (sample === reference) return true;
      
      const distance = calculateDistance(
        reference.lat, reference.lng,
        sample.lat, sample.lng
      );
      
      return distance <= IOS_SAFARI_FIX.OUTLIER_DISTANCE_THRESHOLD;
    });
    
    if (validSamples.length < IOS_SAFARI_FIX.MIN_SAMPLE_COUNT) {
      // 如果有效樣本不足，返回前兩個樣本
      return samples.slice(0, 2);
    }
    
    return validSamples;
  }

  /**
   * 獲取位置錯誤的友好訊息
   * @param {PositionError} error 位置錯誤對象
   * @returns {string} 友好錯誤訊息
   */
  function getPositionErrorMessage(error) {
    if (!error || !error.code) {
      return '未知位置錯誤';
    }
    
    switch (error.code) {
      case 1: // PERMISSION_DENIED
        return '請允許位置權限｜請開啟設定檢查';
      case 2: // POSITION_UNAVAILABLE
        return '無法獲取當前位置｜請確認GPS已開啟';
      case 3: // TIMEOUT
        return '位置請求超時｜請檢查網路連接';
      default:
        return `位置錯誤 (${error.code}): ${error.message || '未知錯誤'}`;
    }
  }

  /**
   * 更新位置重置狀態顯示
   * @param {string} status 狀態訊息
   * @param {number} progress 進度 (0-100)
   */
  function updateResetStatus(status, progress = null) {
    const statusElement = document.getElementById('resetStatusText');
    const progressElement = document.getElementById('resetProgress');
    
    if (statusElement) {
      statusElement.textContent = status;
    }
    
    if (progressElement && progress !== null) {
      progressElement.style.width = `${progress}%`;
    }
  }

  /**
   * 檢測是否為iOS Safari
   * @returns {boolean} 是否為iOS Safari
   */
  function isIOSSafari() {
    const ua = navigator.userAgent.toLowerCase();
    const isIOS = /iphone|ipad|ipod/.test(ua);
    const isSafari = /safari/.test(ua) && !/chrome/.test(ua);
    return isIOS && isSafari;
  }

  /**
   * iOS Safari位置優化流程
   * @returns {Promise<boolean>} 優化完成的Promise
   */
  async function performIOSSafariOptimization() {
    try {
      // 顯示進度容器
      const progressContainer = document.getElementById('resetProgressContainer');
      if (progressContainer) progressContainer.style.display = 'block';
      
      // 隱藏按鈕組
      const buttonGroup = document.querySelector('#incognitoPrompt .button-group');
      if (buttonGroup) buttonGroup.style.display = 'none';
      
      // 更新狀態
      updateResetStatus('開始位置服務優化...', 10);
      
      // 第一步：清除位置快取
      await new Promise(resolve => setTimeout(resolve, 500));
      updateResetStatus('正在清除位置快取...', 30);
      await clearLocationCache();
      
      // 第二步：重置位置服務
      updateResetStatus('正在重置位置服務...', 60);
      await forceGeolocationReset();
      
      // 第三步：獲取測試位置
      updateResetStatus('正在測試位置服務...', 80);
      
      try {
        // 只請求一個樣本，目的只是測試服務是否正常
        await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            position => {
              console.log("位置服務測試成功:", position.coords.latitude, position.coords.longitude);
              resolve(position);
            },
            error => {
              console.warn("位置服務測試失敗:", getPositionErrorMessage(error));
              reject(error);
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        });
        
        // 完成
        updateResetStatus('位置服務優化完成!', 100);
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        return true;
      } catch (error) {
        // 測試位置失敗，但仍然算作優化完成
        updateResetStatus(`優化完成，但測試失敗: ${getPositionErrorMessage(error)}`, 100);
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        return false;
      }
    } catch (error) {
      console.error("iOS Safari優化錯誤:", error);
      
      // 更新錯誤狀態
      updateResetStatus(`優化過程發生錯誤: ${error.message || '未知錯誤'}`, 100);
      
      await new Promise(resolve => setTimeout(resolve, 1500));
      return false;
    } finally {
      // 恢復按鈕組顯示
      const buttonGroup = document.querySelector('#incognitoPrompt .button-group');
      if (buttonGroup) buttonGroup.style.display = 'flex';
      
      // 隱藏進度容器
      const progressContainer = document.getElementById('resetProgressContainer');
      if (progressContainer) progressContainer.style.display = 'none';
    }
  }

  /**
   * 確認離開無痕模式和iOS Safari優化
   */
  async function handleConfirmIncognito() {
    // 檢測是否為iOS Safari
    const isiOSSafari = isIOSSafari();
    
    if (isiOSSafari) {
      try {
        // 執行iOS Safari優化
        await performIOSSafariOptimization();
      } catch (error) {
        console.error("iOS Safari優化失敗:", error);
      }
    }
    
    // 最終關閉提示框
    elements.incognitoPrompt.style.display = "none";
  }

  /**
   * 位置管理 (多點定位)
   */
  const LocationManager = {
    isResetting: false,
    resetAttempts: 0,
    maxResetAttempts: 2,

    // 保存原始方法以便後續覆蓋
    originalGetCurrentLocation: function(sampleCount=5, sampleInterval=500) {
      return new Promise(async (resolve, reject) => {
        if (!("geolocation" in navigator)) {
          reject("瀏覽器不支援定位");
          return;
        }
        
        // 顯示更詳細的載入訊息
        UIUtils.displayLoading(`定位中｜採集 ${sampleCount} 個位置樣本...`);
        
        // 添加進度指示
        let completedSamples = 0;
        const updateProgress = () => {
          completedSamples++;
          UIUtils.displayLoading(`定位中｜已完成 ${completedSamples}/${sampleCount} 個樣本...`);
        };
        
        const getSingleLocation = (index) => {
          return new Promise((resolveLoc, rejectLoc) => {
            setTimeout(() => {
              navigator.geolocation.getCurrentPosition(
                position => {
                  let ts = position.timestamp;
                  if (ts < 1e11) ts = ts*1000;
                  console.log(`位置採樣 #${index+1} 成功: 精度=${position.coords.accuracy}m`);
                  updateProgress(); // 更新進度
                  resolveLoc({
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: ts,
                    sampleIndex: index
                  });
                },
                error => {
                  console.warn(`位置採樣 #${index+1} 失敗: ${error.code}-${error.message}`);
                  updateProgress(); // 更新進度
                  rejectLoc(error);
                },
                { 
                  enableHighAccuracy: true, 
                  timeout: 10000, 
                  maximumAge: 0 
                }
              );
            }, index*sampleInterval);
          });
        };
        
        try {
          const locationPromises = Array.from({length:sampleCount}, (_,i) =>
            getSingleLocation(i).catch(()=> null)
          );
          const results = await Promise.allSettled(locationPromises);
          const successfulResults = results
            .filter(r=>r.status==='fulfilled' && r.value!==null)
            .map(r=>r.value);
          console.log(`位置採樣結果: ${successfulResults.length}/${sampleCount} 成功`);
          if (successfulResults.length>0) {
            const sortedCoords = successfulResults.sort((a,b)=>
              (a.accuracy||9999)-(b.accuracy||9999)
            );
            resolve(sortedCoords);
          } else {
            reject("無法獲取足夠的位置數據");
          }
        } catch(err) {
          reject(`定位系統錯誤: ${err.message||err}`);
        }
      });
    },

    /**
     * 增強版獲取當前位置(iOS Safari優化)
     * @param {number} sampleCount 樣本數量
     * @param {number} sampleInterval 樣本間隔(毫秒)
     * @returns {Promise} 包含位置信息的Promise
     */
    getCurrentLocation: async function(sampleCount=5, sampleInterval=500) {
      // 如果正在重置，拒絕新的請求
      if (this.isResetting) {
        return Promise.reject("位置服務正在重置中，請稍候");
      }
      
      // 檢測是否為iOS Safari
      const isiOSSafari = isIOSSafari();
      
      try {
        // 正常流程嘗試獲取位置
        const coords = await this.originalGetCurrentLocation(sampleCount, sampleInterval);
        
        // 如果是iOS Safari，額外過濾座標
        if (isiOSSafari) {
          console.log("iOS Safari檢測到，應用特殊處理");
          return filterLocationSamples(coords);
        }
        
        return coords;
      } catch (error) {
        // 位置獲取失敗
        console.error("位置獲取失敗:", error);
        
        // 如果是iOS Safari且尚未達到最大重置次數，則嘗試重置
        if (isiOSSafari && this.resetAttempts < this.maxResetAttempts) {
          this.resetAttempts++;
          this.isResetting = true;
          
          console.log(`正在重置位置服務 (嘗試 ${this.resetAttempts}/${this.maxResetAttempts})`);
          UIUtils.displayLoading(`位置服務重置中 (${this.resetAttempts}/${this.maxResetAttempts})...`);
          
          try {
            await forceGeolocationReset();
            this.isResetting = false;
            
            // 重新嘗試獲取位置
            return this.originalGetCurrentLocation(sampleCount, sampleInterval);
          } catch (resetError) {
            this.isResetting = false;
            throw resetError || error;
          }
        }
        
        // 無法恢復，拋出原始錯誤
        throw error;
      } finally {
        // 無論成功失敗，重置標記最終都應清除
        this.isResetting = false;
      }
    }
  };

/* ====================================
     2) 主要功能函式 (打卡、定位、表單)
  =====================================*/

  /**
   * 顯示表單選擇模態框
   */
  function showFormApplicationModal() {
    const formApplicationModal = document.getElementById("formApplicationModal");
    formApplicationModal.classList.add("show");
    formApplicationModal.classList.add("form-overlay");
  }

  /**
   * 隱藏表單選擇模態框
   */
  function hideFormApplicationModal() {
    const formApplicationModal = document.getElementById("formApplicationModal");
    formApplicationModal.classList.remove("show");
    formApplicationModal.classList.remove("form-overlay");
  }

  /**
   * 顯示影片教學
   */
  function showVideoTutorialModal() {
    elements.videoTutorialModal.style.display = "flex";
    elements.tutorialVideo.play().catch(() => (elements.videoFallback.style.display = "block"));
  }

  /**
   * 隱藏影片教學
   */
  function hideVideoTutorialModal() {
    elements.videoTutorialModal.style.display = "none";
    elements.tutorialVideo.pause();
    elements.videoFallback.style.display = "none";
  }

  /**
   * 更新版測試定位功能
   * @param {HTMLButtonElement} button 觸發的按鈕元素
   */
  async function testLocation(button) {
    // 設置操作狀態為進行中
    ButtonStateManager.setOperationStatus(true);
    UIUtils.disableAllButtons();
    
    const idCode = elements.idInput.value;

    if (!validateIdCode(idCode)) {
      UIUtils.displayError("請輸入完整的身分證後四碼");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      return;
    }
    if (!navigator.onLine) {
      UIUtils.displayError("離線無法測試定位");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      return;
    }
    
    UIUtils.displayLoading("定位測試中｜請稍候...");
    
    try {
      // 檢測是否為iOS Safari並提供相關提示
      const isiOSSafari = isIOSSafari();
      if (isiOSSafari) {
        UIUtils.displayIOSMessage("檢測到iOS Safari，啟用特殊定位優化");
      }
      
      // 收集設備信息
      const deviceInfo = DeviceInfoManager.getUpdatedDeviceInfo();
      const deviceInfoStr = JSON.stringify(deviceInfo);
      
      // 獲取位置樣本（增加到5個樣本）
      const coordsList = await LocationManager.getCurrentLocation(5, 500);
      
      // 將設備信息一併傳遞給後端
      const result = await NetworkUtils.callGASWithRetry("testLocationWithAuth", [
        idCode, 
        coordsList, 
        deviceInfoStr  // 新增參數：傳遞設備信息
      ]);

      if (result.status === "success") {
        elements.responseDiv.innerHTML = result.html
          ? `<div class="table-responsive">${result.html}</div>` : "無資料";
        
        // 檢查並顯示穩定性相關警告
        if (result.detail?.stability !== undefined && result.detail.stability < 0.7) {
          const stabilityWarning = document.createElement('div');
          stabilityWarning.style.color = '#FFC107';
          stabilityWarning.style.marginTop = '10px';
          stabilityWarning.style.fontSize = '14px';
          stabilityWarning.innerHTML = `<i class="material-icons" style="vertical-align:middle;font-size:16px;margin-right:5px;">warning</i>GPS 信號不穩定 (${Math.round(result.detail.stability*100)}%)`;
          elements.responseDiv.appendChild(stabilityWarning);
        }
        
        // 顯示iOS Safari特殊處理的相關信息
        if (result.detail?.isIOSSafari) {
          const iosSafariInfo = document.createElement('div');
          iosSafariInfo.style.color = '#4CAF50';
          iosSafariInfo.style.marginTop = '10px';
          iosSafariInfo.style.fontSize = '14px';
          iosSafariInfo.innerHTML = `<i class="material-icons" style="vertical-align:middle;font-size:16px;margin-right:5px;">check_circle</i>iOS Safari 優化已啟用`;
          elements.responseDiv.appendChild(iosSafariInfo);
        }
        
        elements.responseDiv.classList.add("show");
        UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
        UIUtils.enableAllButtonsExcept(button);
      } else {
        UIUtils.displayError(result.message);
        UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
        UIUtils.enableAllButtonsExcept(button);
      }
    } catch(err) {
      // 判斷是否為位置錯誤
      if (err.code && (err.code === 1 || err.code === 2 || err.code === 3)) {
        UIUtils.displayError(`位置獲取失敗: ${getPositionErrorMessage(err)}`);
      } else {
        UIUtils.displayError(`測試失敗: ${err.message}`);
      }
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
    } finally {
      ButtonStateManager.setOperationStatus(false);
    }
  }

  /**
   * 查詢今日打卡記錄
   */
  async function queryTodayRecords(button) {
    // 設置操作狀態為進行中
    ButtonStateManager.setOperationStatus(true);
    UIUtils.disableAllButtons();
    
    const idCode = elements.idInput.value;

    if (!validateIdCode(idCode)) {
      UIUtils.displayError("請輸入完整的身分證後四碼");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      return;
    }
    if (!navigator.onLine) {
      UIUtils.displayError("離線無法查詢");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      return;
    }
    UIUtils.displayLoading("查詢中｜請稍候...");

    try {
      const result = await NetworkUtils.callGASWithRetry("queryTodayRecords", [idCode]);
      if (result.status === "success") {
        elements.responseDiv.innerHTML = result.html
          ? `<div class="table-responsive">${result.html}</div>`
          : "無資料";
        elements.responseDiv.classList.add("show");
        UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
        UIUtils.enableAllButtonsExcept(button);
      } else {
        UIUtils.displayError(result.message);
        UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
        UIUtils.enableAllButtonsExcept(button);
      }
    } catch(err) {
      UIUtils.displayError(`查詢失敗: ${err.message}`);
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
    } finally {
      ButtonStateManager.setOperationStatus(false);
    }
  }

  /**
   * 開始打卡動作流程
   */
  async function startClockAction(action, force, button) {
    // 設置操作狀態為進行中
    ButtonStateManager.setOperationStatus(true);
    UIUtils.disableAllButtons();
    
    const idCode = elements.idInput.value;

    if (!validateIdCode(idCode)) {
      UIUtils.displayError("請輸入完整的身分證後四碼");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      return;
    }
    if (!navigator.onLine) {
      UIUtils.displayError("請確認網路連線");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      return;
    }
    UIUtils.displayLoading("檢查中｜請稍候...");

    try {
      const result = await NetworkUtils.callGASWithRetry("checkDeviceBinding", [idCode]);

      if (result.status === "success") {
        startCountdown(action, force, false, button);
      } else if (result.status === "error") {
        if (result.error === "AUTH.NOT_BOUND") {
          const browser = BrowserUtils.parseBrowser(navigator.userAgent);
          UIUtils.showCustomConfirm(
            "裝置綁定確認",
            `是否同意綁定 ${browser}`,
            () => startCountdown(action, force, true, button),
            () => {
              UIUtils.displayError("已取消打卡");
              UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
              UIUtils.enableAllButtonsExcept(button);
              ButtonStateManager.setOperationStatus(false);
            }
          );
        } else {
          UIUtils.displayError(result.message);
          UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
          UIUtils.enableAllButtonsExcept(button);
          ButtonStateManager.setOperationStatus(false);
        }
      }
    } catch(err) {
      UIUtils.displayError(`檢查失敗: ${err.message}`);
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      ButtonStateManager.setOperationStatus(false);
    }
  }

  /**
   * 5 秒倒數
   */
  function startCountdown(action, force, bindDevice, button) {
    // 保持操作狀態為進行中
    ButtonStateManager.setOperationStatus(true);
    UIUtils.disableAllButtons();
    
    elements.overlay.classList.add("show");
    elements.modalTitle.textContent = "打卡確認";

    let countdown = 5;
    elements.modalMessage.textContent = `將於 ${countdown} 秒後建立 ${action} 打卡`;

    const timer = setInterval(()=>{
      countdown--;
      elements.modalMessage.textContent = `將於 ${countdown} 秒後建立 ${action} 打卡`;

      if (countdown<=0) {
        clearInterval(timer);
        elements.overlay.classList.remove("show");
        handleAction(action, force, bindDevice, button);
      }
    }, 1000);

    elements.confirmBtn.onclick = () => {
      clearInterval(timer);
      elements.overlay.classList.remove("show");
      handleAction(action, force, bindDevice, button);
    };
    elements.cancelBtn.onclick = () => {
      clearInterval(timer);
      elements.overlay.classList.remove("show");
      UIUtils.displayError("已取消打卡");
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
      ButtonStateManager.setOperationStatus(false);
    };
  }

  /**
   * 更新版實際打卡動作
   * @param {string} action 打卡動作（上班/下班）
   * @param {boolean} force 是否強制打卡
   * @param {boolean} bindDevice 是否綁定設備
   * @param {HTMLButtonElement} button 觸發的按鈕元素
   */
  async function handleAction(action, force, bindDevice, button) {
    // 保持操作狀態為進行中
    ButtonStateManager.setOperationStatus(true);
    UIUtils.disableAllButtons();
    
    const idCode = elements.idInput.value;
    UIUtils.displayLoading("審核中｜請稍候...");

    try {
      // 檢測是否為iOS Safari
      const isiOSSafari = isIOSSafari();
      if (isiOSSafari) {
        UIUtils.displayIOSMessage("檢測到iOS Safari，啟用特殊定位優化");
      }
      
      // 收集設備信息（新版本支持iOS Safari）
      const deviceInfo = JSON.stringify(DeviceInfoManager.getUpdatedDeviceInfo());
      const currentDeviceInfo = JSON.stringify(DeviceInfoManager.getUpdatedDeviceInfo());
      const coordsList = await LocationManager.getCurrentLocation(5, 500); // 增加到5個樣本
      const uuid = await DeviceIdManager.getDeviceUuid();
      const ip = await NetworkUtils.getIPAddress();
      console.log(`開始${action}打卡請求...`);

      const result = await NetworkUtils.callGASWithRetry("gpsCheckin", [
        idCode, deviceInfo, action, coordsList, force, bindDevice, uuid, ip, currentDeviceInfo
      ]);

      if (result.status === "success") {
        let finalMsg = result.message;
        if (result.detail?.time) {
          finalMsg += `<br><span style="color:#fff;">${result.detail.time}</span>`;
        }
        
        // 增加對安全邊界的顯示
        if (result.detail?.safetyMargin && result.detail.safetyMargin > 0) {
          finalMsg += `<br><span style="color:#FFC107;">已加入 ${result.detail.safetyMargin} 公尺安全邊界</span>`;
        }
        
        // 增加對信號穩定度的顯示
        if (result.detail?.stability !== undefined) {
          const stabilityPercent = Math.round(result.detail.stability * 100);
          const stabilityColor = stabilityPercent >= 70 ? '#4CAF50' : stabilityPercent >= 50 ? '#FFC107' : '#FF5722';
          finalMsg += `<br><span style="color:${stabilityColor};">GPS 信號穩定度: ${stabilityPercent}%</span>`;
        }
        
        // 添加iOS Safari特殊處理的提示
        if (result.detail?.isIOSSafari) {
          finalMsg += `<br><span style="color:#4CAF50;">iOS Safari 優化已啟用</span>`;
        }
        
        if (result.detail?.gpsAccuracy) {
          finalMsg += `<br><span style="color:#76ff03;">${result.detail.gpsAccuracy}</span>`;
        }
        
        UIUtils.displaySuccess(finalMsg);
        UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
        UIUtils.enableAllButtonsExcept(button);
      } else {
        let finalMsg = result.message || "系統錯誤｜請稍後再試";
        if (result.error === "SHIFT.INSUFFICIENT_REST") {
          finalMsg = "休息時間不足｜請稍後再試";
        } else if (result.error === "SYS.RATE_LIMIT_EXCEEDED") {
          finalMsg = "操作過於頻繁｜請稍後再試";
        } else if (result.error === "GPS.OUT_OF_RANGE" || result.error === "GPS.RANGE_ERROR") {
          finalMsg = "超出可打卡範圍｜請重新開關網路";
        } else if (result.error === "BROWSER.UNSUPPORTED") {
          finalMsg = "瀏覽器不支援｜應使用Chrome、Firefox或Edge";
        } else if (result.error === "AUTH.DEVICE_MISMATCH") {
          finalMsg += "<br><span style='color:yellow;'>裝置異常｜請洽營運組</span>";
        } else if (result.error === "AUTH.DEVICE_TYPE_MISMATCH") {
          finalMsg += "<br><span style='color:yellow;'>綁定裝置不符｜請洽營運組</span>";
        }
        
        // 對於位置相關錯誤，如果是iOS Safari，添加特殊提示
        if (isiOSSafari && (
            result.error === "GPS.INVALID_COORDS" || 
            result.error === "GPS.INVALID_FORMAT" || 
            result.error === "GPS.OUT_OF_RANGE")) {
          finalMsg += "<br><span style='color:#FFC107;'>iOS設備可能需要重設位置服務</span>";
          
          // 添加重置位置服務的按鈕
          finalMsg += `<br><button id="resetLocationBtn" style="margin-top:10px; padding:8px 15px; background:#2196F3; color:white; border:none; border-radius:4px; cursor:pointer;">重設位置服務</button>`;
          
          // 為按鈕添加點擊事件（在訊息顯示後）
          setTimeout(() => {
            const resetBtn = document.getElementById('resetLocationBtn');
            if (resetBtn) {
              resetBtn.addEventListener('click', async () => {
                UIUtils.displayLoading("正在重置位置服務，請稍候...");
                try {
                  await forceGeolocationReset();
                  UIUtils.displaySuccess("位置服務已重置，請再次嘗試打卡");
                } catch (err) {
                  UIUtils.displayError(`位置服務重置失敗: ${err.message}`);
                }
              });
            }
          }, 100);
        }
        
        if (result.detail) {
          finalMsg += `<br><span style="font-size:14px; color:#999;">詳細資訊: ${JSON.stringify(result.detail)}</span>`;
        }
        
        UIUtils.displayError(finalMsg);
        UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
        UIUtils.enableAllButtonsExcept(button);
      }
    } catch(err) {
      // 判斷是否為位置錯誤
      if (err.code && (err.code === 1 || err.code === 2 || err.code === 3)) {
        UIUtils.displayError(`位置獲取失敗: ${getPositionErrorMessage(err)}`);
      } else {
        UIUtils.displayError(`連線失敗: ${err.message}`);
      }
      UIUtils.startIndividualCooldown(button, CONFIG.COOLDOWN_MS, button.dataset.originalText);
      UIUtils.enableAllButtonsExcept(button);
    } finally {
      ButtonStateManager.setOperationStatus(false);
    }
  }

/* ====================================
     3) 綁定事件 & 初始化
  =====================================*/

  /**
   * 設置事件監聽器
   */
  function setupEventListeners() {
    // 切換密碼顯示
    elements.toggleBtn.addEventListener("click", () => {
      elements.idInput.type = (elements.idInput.type==="password") ? "text" : "password";
      elements.eyeIcon.textContent = (elements.idInput.type==="password") ? "visibility" : "visibility_off";
      elements.idInput.focus();
    });

    // 輸入驗證
    elements.idInput.addEventListener("input", () => {
      if (!/^\d*$/.test(elements.idInput.value)) {
        elements.idInput.value = elements.idInput.value.replace(/\D/g, "");
        elements.errorSpan.textContent = "只允許輸入 4 位數字";
        elements.errorSpan.classList.add("show");
      } else {
        elements.errorSpan.textContent = "";
        elements.errorSpan.classList.remove("show");
      }
      elements.idInput.setCustomValidity(elements.idInput.value.length!==4 ? "必須輸入 4 位數" : "");
      if (validateIdCode(elements.idInput.value)) {
        UIUtils.enableAllButtons();
      } else {
        UIUtils.disableAllButtons();
      }
    });
    
    elements.idInput.addEventListener("blur", () => {
      elements.errorSpan.textContent = "";
      elements.errorSpan.classList.remove("show");
      elements.idInput.setCustomValidity(elements.idInput.value.length!==4 ? "必須輸入 4 位數" : "");
    });

    // 影片教學
    elements.closeVideoModal.addEventListener("click", hideVideoTutorialModal);
    elements.tutorialVideo.addEventListener("error", () => {
      elements.tutorialVideo.style.display = "none";
      elements.videoFallback.style.display = "block";
    });

    // 無痕瀏覽器提示 - 更新確認按鈕事件以支持iOS Safari優化
    elements.confirmIncognito.addEventListener("click", handleConfirmIncognito);
    elements.cancelIncognito.addEventListener("click", () => {
      alert("已取消｜無法使用系統");
      window.location.href="about:blank";
    });

    // iOS Safari資訊確認按鈕事件
    const iosSafariInfoConfirm = document.getElementById('iosSafariInfoConfirm');
    if (iosSafariInfoConfirm) {
      iosSafariInfoConfirm.addEventListener('click', function() {
        document.getElementById('iosSafariInfoModal').style.display = 'none';
      });
    }

    // 功能按鈕
    elements.allButtons.btnOn.addEventListener("click", () =>
      startClockAction("上班", false, elements.allButtons.btnOn)
    );
    elements.allButtons.btnOff.addEventListener("click", () =>
      startClockAction("下班", false, elements.allButtons.btnOff)
    );

    // 防抖後的定位 & 查詢
    const debouncedTestLocation = debounce(testLocation, 300);
    elements.allButtons.btnTest.addEventListener("click", () => {
      debouncedTestLocation(elements.allButtons.btnTest);
    });

    const debouncedQueryRecords = debounce(queryTodayRecords, 300);
    elements.allButtons.btnQuery.addEventListener("click", () => {
      debouncedQueryRecords(elements.allButtons.btnQuery);
    });

    // 表單
    elements.allButtons.btnForm.addEventListener("click", () => {
      showFormApplicationModal();
    });

    document.getElementById("closeFormModal")
      .addEventListener("click", hideFormApplicationModal);

    const formAppModal = document.getElementById("formApplicationModal");
    formAppModal.addEventListener("click", (e) => {
      if (e.target === formAppModal) {
        hideFormApplicationModal();
      }
    });

    // 表單項目
    document.getElementById("overtimeForm").addEventListener("click", () => {
      UIUtils.showCustomConfirm("加班申請","加班申請功能開發中，即將推出",()=>{
        hideFormApplicationModal();
      });
    });
    document.getElementById("cardCorrectionForm").addEventListener("click", () => {
      UIUtils.showCustomConfirm("補卡申請","補卡申請功能開發中，即將推出",()=>{
        hideFormApplicationModal();
      });
    });
    document.getElementById("leaveRequestForm").addEventListener("click", () => {
      UIUtils.showCustomConfirm("請假申請","請假申請功能開發中，即將推出",()=>{
        hideFormApplicationModal();
      });
    });
  }

  /**
   * 初始化函數
   */
  function init() {
    // 嘗試恢復設備ID
    DeviceIdManager.recoverDeviceId();
    
    // 檢測並顯示Safari通知
    BrowserUtils.showSafariNotice();
    
    // 設置事件監聽
    setupEventListeners();
    
    // 更新網絡狀態
    NetworkUtils.updateNetworkStatus();
    
    // 替換為增強版無痕模式處理
    handleIncognitoMode();
    
    // 定期檢查設備ID一致性
    setInterval(DeviceIdManager.validateStoredIds, CONFIG.CONSISTENCY_CHECK_INTERVAL);
    
    // 檢查是否為iOS Safari，並顯示特殊提示
    if (typeof isIOSSafari === 'function' && isIOSSafari()) {
      // 首次訪問時顯示iOS Safari說明
      const hasSeenIOSTip = localStorage.getItem('hasSeenIOSTip');
      if (!hasSeenIOSTip) {
        // 設置定時器，等待無痕模式提示關閉後顯示
        setTimeout(function() {
          if (document.getElementById('incognitoPrompt').style.display === 'none') {
            document.getElementById('iosSafariInfoModal').style.display = 'flex';
            localStorage.setItem('hasSeenIOSTip', 'true');
          } else {
            // 如果無痕模式提示還在，再等待1秒
            setTimeout(function() {
              document.getElementById('iosSafariInfoModal').style.display = 'flex';
              localStorage.setItem('hasSeenIOSTip', 'true');
            }, 1000);
          }
        }, 500);
      }
    }
  }

  /**
   * 無痕模式處理增強版
   */
  function handleIncognitoMode() {
    try {
      // 檢測是否為iOS Safari
      const isiOSSafari = isIOSSafari();
      
      // 如果是iOS Safari，提供特殊處理選項
      if (isiOSSafari) {
        // 更新無痕提示文字
        const promptTitle = document.querySelector('#incognitoPrompt h2');
        const promptText = document.querySelector('#incognitoPrompt p');
        const confirmBtn = document.getElementById('confirmIncognito');
        
        if (promptTitle) promptTitle.textContent = "iOS Safari檢測";
        if (promptText) promptText.innerHTML = "檢測到您正在使用iOS Safari瀏覽器<br>需要進行位置服務優化以確保打卡成功";
        if (confirmBtn) confirmBtn.textContent = "開始位置優化";
        
        // 添加進度顯示區域，如果不存在的話
        if (!document.getElementById('resetProgressContainer')) {
          const progressContainer = document.getElementById('resetProgressContainer');
          if (progressContainer) {
            progressContainer.style.display = 'none';
          }
        }
      }
      
      // 顯示無痕提示對話框
      elements.incognitoPrompt.style.display = "flex";
    } catch (error) {
      console.error("無痕模式處理錯誤:", error);
      // 出錯時直接顯示普通提示
      elements.incognitoPrompt.style.display = "flex";
    }
  }

  // 註冊事件監聽器
  window.addEventListener("online", NetworkUtils.updateNetworkStatus);
  window.addEventListener("offline", NetworkUtils.updateNetworkStatus);
  window.addEventListener("load", init);
</script>
</body>
</html>
